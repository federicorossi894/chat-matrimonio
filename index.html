<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Matrimonio</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --text:#111; --muted:#666;
      --pri:#111; --priText:#fff; --soft:#ededf0; --accent:#111;
      --chip:#eee; --ok:#0a7b34; --err:#b00020;
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --radius:18px; --radiusSm:10px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:680px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h1{font-size:32px;margin:8px 0 14px}
    h2{font-size:20px;margin:8px 0 10px}
    p{margin:0 0 10px}
    .center{text-align:center}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:14px 16px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--pri);color:var(--priText)}
    .btn.soft{background:var(--soft);color:var(--text)}
    .btn.full{width:100%}
    .stack-12>*{margin-top:12px}
    .stack-16>*{margin-top:16px}
    .row{display:flex;align-items:center;gap:10px}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:var(--chip);border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
    /* Tabs header */
    .topbar{display:flex;align-items:center;gap:8px;justify-content:flex-start;margin-bottom:12px}
    .tab{padding:10px 16px;border-radius:999px;background:var(--soft);cursor:pointer;font-weight:700}
    .tab.active{background:#111;color:#fff}
    .spacer{flex:1}
    .iconBtn{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;background:var(--soft);font-size:22px;cursor:pointer}
    /* Chat layout */
    .chatShell{display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .msgList{height:52vh;overflow:auto;border-radius:12px;background:#fff;border:1px solid #eee;padding:10px}
    .msg{display:flex;align-items:flex-start;gap:8px;margin:8px 0;max-width:96%}
    .msg.me .bubble{background:#111;color:#fff}
    .avatar{min-width:34px;height:34px;border-radius:999px;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700;color:#444;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .bubble{background:#f1f1f4;border-radius:14px;padding:8px 10px}
    .small{font-size:12px}
    .inputRow{display:flex;gap:8px}
    .inputRow input{flex:1;padding:14px;border-radius:12px;border:1px solid #ddd;background:#fff}
    /* Drawer elenco DM */
    .dmList{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px}
    .dmItem{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;cursor:pointer}
    .dmItem:hover{background:#f5f5f7}
    .hint{background:#fff8e1;border:1px solid #ffe2a3;border-radius:12px;padding:10px}
    /* Overlay generico */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .sheet{width:min(680px,100%);max-height:86vh;overflow:auto;background:#fff;border-radius:20px;padding:16px;box-shadow:var(--shadow)}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .footRight{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    /* Form */
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field input,.field select{padding:14px;border-radius:12px;border:1px solid #ddd;background:#fff}
    .radioRow{display:grid;grid-template-columns:auto 1fr;gap:10px;margin:8px 0;align-items:center}
    .statusRow{display:grid;grid-template-columns:auto 1fr;gap:12px;margin:8px 0}
    /* FAB profilo */
    .fab{position:fixed;right:18px;bottom:18px;background:#fff;border:1px solid #eee;box-shadow:var(--shadow);border-radius:999px;padding:8px 12px;display:flex;align-items:center;gap:8px;cursor:pointer;z-index:20}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;border-radius:999px;padding:10px 14px;display:none;z-index:50}
    /* Full photo */
    .photoView{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:60}
    .photoView img{max-width:94vw;max-height:90vh;border-radius:12px}
    /* Small helpers */
    .hidden{display:none !important}
    @media (max-width:480px){
      .msgList{height:56vh}
    }
  </style>
</head>
<body>
<div class="wrap" id="app">

  <!-- HOME -->
  <section id="home" class="card center">
    <div class="avatar" style="margin:0 auto 8px;width:54px;height:54px;">EF</div>
    <h1>Benvenuto üéâ</h1>
    <p>Qui puoi <b>conoscere e chattare con gli altri invitati</b> del matrimonio.</p>
    <p>Puoi lanciare un brindisi speciale <span aria-hidden="true">üçæ</span> per rompere il ghiaccio,</p>
    <p>oppure aprire una <b>chat privata</b> <span aria-hidden="true">üí¨</span> per parlare direttamente con chi vuoi.</p>
    <p class="muted" style="margin-top:10px"><b>Nota:</b> tutto quello che succede qui si cancella dopo <b>72 ore</b>‚Ä¶ quindi divertiti e lasciati andare üòâ</p>
    <div class="stack-12" style="margin-top:14px">
      <button id="btnNew" class="btn primary full">Crea nuovo profilo</button>
      <button id="btnLogin" class="btn soft full">Rientra nel tuo profilo</button>
    </div>
  </section>

  <!-- MAIN CHAT -->
  <section id="main" class="hidden">
    <div class="topbar">
      <div id="tabDMs" class="tab active">Private</div>
      <div id="tabTable" class="tab">Tavolo</div>
      <div class="spacer"></div>
      <div id="btnBrindisi" class="iconBtn" title="Proponi brindisi">üçæ</div>
      <div id="btnNewChat" class="iconBtn" title="Nuova chat">Ôºã</div>
      <div id="btnAnnuncio" class="iconBtn hidden" title="Annuncio staff">üì¢</div>
    </div>

    <!-- PRIVATE COLUMN -->
    <div id="colDM" class="chatShell">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:6px 0">Chat private</h2>
          <!-- (rimosso il vecchio ‚ÄúApri o crea‚Ä¶‚Äù) -->
        </div>

        <!-- finestra chat privata -->
        <div id="dmWindow" class="msgList">
          <div class="muted" style="text-align:center;margin-top:18px">Seleziona una chat dall‚Äôelenco o premi ‚ÄúNuova chat privata‚Äù.</div>
        </div>
        <div class="inputRow">
          <input id="dmInput" placeholder="Scrivi un messaggio‚Ä¶" />
          <button id="dmSend" class="btn primary">Invia</button>
        </div>
      </div>

      <!-- elenco chat -->
      <div class="dmList" style="margin-top:10px">
        <h3 style="margin:6px 8px">Le tue chat</h3>
        <div id="dmEmpty" class="muted" style="padding:8px 10px">Nessuna chat privata. Premi ‚ÄúNuova chat privata‚Äù.</div>
        <div id="dmList"></div>
      </div>
    </div>

    <!-- TAVOLO COLUMN -->
    <div id="colTable" class="chatShell hidden">
      <div class="panel">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row" style="gap:8px">
            <div id="tableBadge" class="avatar" style="width:34px;height:34px">T</div>
            <h2 id="tableTitle" style="margin:0">Tavolo</h2>
          </div>
          <!-- RIMOSSA chip ‚ÄúChat del tavolo‚Äù -->
        </div>

        <div id="tableMessages" class="msgList"></div>

        <div class="inputRow">
          <input id="tableInput" placeholder="Scrivi un messaggio‚Ä¶" />
          <button id="tableSend" class="btn primary">Invia</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FAB profilo -->
  <div id="fabProfile" class="fab hidden">
    <div id="fabAva" class="avatar" style="width:28px;height:28px">L</div>
    <span>Profilo</span>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">Ok</div>

  <!-- VIEW PHOTO -->
  <div id="photoFull" class="photoView"><img alt="foto profilo" /></div>

  <!-- OVERLAYS -->

  <!-- login / new -->
  <div id="ovAuth" class="overlay">
    <div class="sheet" style="max-width:560px">
      <h2 id="authTitle">Crea nuovo profilo</h2>
      <div id="authStep1">
        <div class="field"><label>Nome</label><input id="aName" placeholder="es. Giulia R." /></div>
        <div class="twoCols">
          <div class="field"><label>PIN (4 cifre)</label><input id="aPin" inputmode="numeric" maxlength="4" placeholder="PIN" /></div>
          <div class="field"><label>Tavolo</label>
            <select id="aTable">
              <option value="" selected>Seleziona tavolo</option>
              <option>Tavolo 1</option><option>Tavolo 2</option><option>Tavolo 3</option>
              <option>Tavolo 4</option><option>Tavolo 5</option><option>Tavolo 6</option>
              <option>Tavolo 7</option><option>Tavolo 8</option><option>Tavolo 9</option><option>Tavolo 10</option>
            </select>
          </div>
        </div>
      </div>

      <!-- step 2: selfie + status -->
      <div id="authStep2" class="hidden">
        <h3 style="margin:6px 0 6px">Personalizza (opzionale)</h3>
        <div class="field">
          <label>Selfie (meglio ora üòâ)</label>
          <input id="aPhoto" type="file" accept="image/*" capture="environment">
          <div class="muted small">Consiglio: scatta un selfie adesso, √® pi√π divertente!</div>
        </div>
        <div class="statusRow"><div class="avatar" style="width:30px;height:30px">üíç</div><div><b>Impegnato/a</b></div></div>
        <div class="statusRow"><div class="avatar" style="width:30px;height:30px">üí¨</div><div><b>Disponibile a chiacchierare</b></div></div>
        <div class="statusRow"><div class="avatar" style="width:30px;height:30px">üéâ</div><div><b>Voglia di far festa</b></div></div>
        <div class="statusRow"><div class="avatar" style="width:30px;height:30px">‚ú®</div><div><b>Sorprendimi</b></div></div>
        <div class="chips" id="statusPick">
          <div class="chip" data-emo="üíç">üíç</div>
          <div class="chip" data-emo="üí¨">üí¨</div>
          <div class="chip" data-emo="üéâ">üéâ</div>
          <div class="chip" data-emo="‚ú®">‚ú®</div>
          <div class="chip" data-emo="">Nessuna</div>
        </div>
        <label class="radioRow"><input id="aOptOut" type="checkbox" />üôà <span>Non ricevere sfide private (brindisi)</span></label>
      </div>

      <div class="footRight">
        <button id="aCancel" class="btn soft">Chiudi</button>
        <button id="aNext" class="btn primary">Continua</button>
      </div>
      <div id="authErr" class="muted" style="color:var(--err);margin-top:6px"></div>
    </div>
  </div>

  <!-- ricerca persone/tavoli (per DM e Brindisi) -->
  <div id="ovSearch" class="overlay">
    <div class="sheet">
      <h2 id="searchTitle">Cerca ospite o tavolo</h2>
      <div class="field"><input id="sQuery" placeholder="Scrivi nome o tavolo‚Ä¶" /></div>
      <div id="sResults"></div>
      <div class="footRight"><button id="sClose" class="btn soft">Chiudi</button></div>
    </div>
  </div>

  <!-- picker Brindisi -->
  <div id="ovBrindisi" class="overlay">
    <div class="sheet">
      <h2 id="brindisiTitle">Proponi brindisi</h2>
      <div id="bGrid" class="twoCols" style="margin-top:8px"></div>
      <div class="field" style="margin-top:10px"><input id="bCustom" placeholder="Oppure scrivi la tua sfida‚Ä¶" /></div>
      <div class="footRight">
        <button id="bShuffle" class="btn soft">Altri suggerimenti</button>
        <button id="bCancel" class="btn soft">Annulla</button>
        <button id="bSend" class="btn primary">Invia</button>
      </div>
      <div id="bErr" class="muted" style="color:var(--err);margin-top:6px"></div>
    </div>
  </div>

  <!-- annuncio staff -->
  <div id="ovAnnuncio" class="overlay">
    <div class="sheet">
      <h2>Invia annuncio a tutti</h2>
      <div class="field"><input id="annText" placeholder="Testo dell‚Äôannuncio‚Ä¶" /></div>
      <div class="footRight">
        <button id="annCancel" class="btn soft">Annulla</button>
        <button id="annSend" class="btn primary">Invia</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase (CDN compat per evitare 404) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

<script type="module">
/* ========= UTIL ========= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const keyify = s => (s||'').trim().toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]/g,'').slice(0,32);
const now = () => Date.now();
const toast = (t)=>{ const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',2000); };
const show = id => $$('#home,#main').forEach(x=>x.id===id?x.classList.remove('hidden'):x.classList.add('hidden'));
const openOverlay = el => { el.style.display='flex'; }
const closeOverlay = el => { el.style.display='none'; }
const randPick = (arr, n) => arr.sort(()=>Math.random()-0.5).slice(0,n);

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyAGGNyJE0Nj_KMb-jHjxWXTULa-gT3W9XQ",
  authDomain: "chat-matrimonio.firebaseapp.com",
  projectId: "chat-matrimonio",
  storageBucket: "chat-matrimonio.firebasestorage.app",
  messagingSenderId: "533930991153",
  appId: "1:533930991153:web:d4c47af448e6ebfce73f10",
  databaseURL: "https://chat-matrimonio-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ========= STATO ========= */
let currentUser = null;     // {id, nome, tavolo, emoji, photoURL, isStaff, optOut}
let dmPeer = null;          // utente aperto nei DM
let dmIdOpen = null;        // id chat aperta
let tablePath = null;       // path chat tavolo corrente
let unsubDM = null, unsubTable = null;

/* ========= HOME BTN ========= */
$('#btnNew').onclick = ()=> openAuth(true);
$('#btnLogin').onclick = ()=> openAuth(false);

/* ========= AUTH ========= */
function openAuth(isNew){
  $('#authTitle').textContent = isNew ? 'Crea nuovo profilo' : 'Rientra nel tuo profilo';
  $('#aNext').textContent = 'Continua';
  $('#authErr').textContent = '';
  $('#authStep1').classList.remove('hidden');
  $('#authStep2').classList.add('hidden');
  $('#aName').value = ''; $('#aPin').value = ''; $('#aTable').value = '';
  $('#aPhoto').value = ''; $('#aOptOut').checked = false;
  $$('#statusPick .chip').forEach(c=>c.classList.remove('active'));
  $('#aNext').dataset.mode = isNew ? 'new1' : 'login';
  openOverlay($('#ovAuth'));
}

$('#aCancel').onclick = ()=> closeOverlay($('#ovAuth'));

$('#aNext').onclick = async ()=>{
  const mode = $('#aNext').dataset.mode;

  if (mode==='login'){
    const nome = $('#aName').value.trim();
    const pin  = $('#aPin').value.trim();
    const tav  = $('#aTable').value.trim(); // obbligatorio anche qui
    if (!nome || !pin || !/^\d{4}$/.test(pin) || !tav){ $('#authErr').textContent='Compila nome, PIN (4 cifre) e tavolo.'; return; }
    const id = keyify(nome);
    const snap = await db.ref('users/'+id).get();
    if (!snap.exists()){ $('#authErr').textContent='Utente non trovato. Crea un profilo.'; return; }
    const u = snap.val();
    if (String(u.pin)!==pin || u.tavolo!==tav){ $('#authErr').textContent='Nome/PIN/Tavolo non corrispondono.'; return; }
    currentUser = {...u, id};
    afterLogin();
    closeOverlay($('#ovAuth'));
    return;
  }

  if (mode==='new1'){
    const nome = $('#aName').value.trim();
    const pin  = $('#aPin').value.trim();
    const tav  = $('#aTable').value.trim();
    if (!nome || !pin || !/^\d{4}$/.test(pin) || !tav){ $('#authErr').textContent='Compila nome, PIN (4 cifre) e tavolo.'; return; }
    // step 2
    $('#authStep1').classList.add('hidden');
    $('#authStep2').classList.remove('hidden');
    $('#aNext').textContent = 'Salva e entra';
    $('#aNext').dataset.mode = 'new2';
    return;
  }

  if (mode==='new2'){
    const nome = $('#aName').value.trim();
    const pin  = $('#aPin').value.trim();
    const tav  = $('#aTable').value.trim();
    const id = keyify(nome);
    const emoji = $('#statusPick .chip.active')?.dataset.emo || '';
    const optOut = $('#aOptOut').checked;

    let photoURL = '';
    const f = $('#aPhoto').files[0];
    if (f){
      if (!/^image\//.test(f.type)){ $('#authErr').textContent='Carica un\'immagine.'; return; }
      const path = `pfp/${keyify(tav)}/${id}.jpg`;
      const upload = await storage.ref(path).put(f);
      photoURL = await upload.ref.getDownloadURL();
    }

    const userData = { nome, pin, tavolo:tav, emoji, photoURL, optOut, isStaff:false, ts:now() };
    await db.ref('users/'+id).set(userData);
    currentUser = {...userData, id};
    afterLogin();
    closeOverlay($('#ovAuth'));
    return;
  }
};

$('#statusPick').addEventListener('click', (e)=>{
  const c = e.target.closest('.chip'); if(!c) return;
  $$('#statusPick .chip').forEach(x=>x.classList.remove('active'));
  c.classList.add('active');
});

/* ========= DOPO LOGIN ========= */
function afterLogin(){
  // UI base
  $('#fabProfile').classList.remove('hidden');
  $('#btnAnnuncio').classList.toggle('hidden', !currentUser.isStaff);
  $('#fabAva').textContent = (currentUser.nome||'?').substring(0,1).toUpperCase();
  if (currentUser.photoURL){ const i=document.createElement('img'); i.src=currentUser.photoURL; $('#fabAva').innerHTML=''; $('#fabAva').appendChild(i); }
  $('#tableBadge').textContent='T';
  $('#tableTitle').textContent = currentUser.tavolo;
  show('main');
  // apri per default PRIVATE
  setTab('dms');

  // attach listeners principale
  listenTable();
  refreshDMList();

  // annunci (una volta per device)
  listenAnnouncements();

  toast('Benvenut* ' + currentUser.nome + '!');
}

/* ========= TABS ========= */
$('#tabDMs').onclick   = ()=> setTab('dms');
$('#tabTable').onclick = ()=> setTab('table');

function setTab(which){
  const onDM = which==='dms';
  $('#tabDMs').classList.toggle('active', onDM);
  $('#tabTable').classList.toggle('active', !onDM);
  $('#colDM').classList.toggle('hidden', !onDM);
  $('#colTable').classList.toggle('hidden', onDM);
}

/* ========= PROFILO ========= */
$('#fabProfile').onclick = openProfile;
function openProfile(){
  // riutilizzo overlay auth step2 come editor veloce
  $('#authTitle').textContent = 'Profilo';
  $('#authStep1').classList.add('hidden');
  $('#authStep2').classList.remove('hidden');
  $('#aNext').textContent = 'Salva';
  $('#aNext').dataset.mode = 'saveProfile';
  $('#aName').value = currentUser.nome;
  $('#aPin').value = currentUser.pin;
  $('#aTable').value = currentUser.tavolo;
  $('#aOptOut').checked = !!currentUser.optOut;
  $$('#statusPick .chip').forEach(c=>{
    c.classList.toggle('active', c.dataset.emo === (currentUser.emoji||''));
  });
  openOverlay($('#ovAuth'));
}

$('#aNext').addEventListener('click', async (e)=>{
  if ($('#aNext').dataset.mode!=='saveProfile') return;
  const emoji = $('#statusPick .chip.active')?.dataset.emo || '';
  const optOut = $('#aOptOut').checked;
  let photoURL = currentUser.photoURL || '';
  const f = $('#aPhoto').files[0];
  if (f){
    const path = `pfp/${keyify(currentUser.tavolo)}/${currentUser.id}.jpg`;
    const upload = await storage.ref(path).put(f);
    photoURL = await upload.ref.getDownloadURL();
  }
  await db.ref('users/'+currentUser.id).update({ emoji, optOut, photoURL });
  currentUser = {...currentUser, emoji, optOut, photoURL};
  if (photoURL){ const i=document.createElement('img'); i.src=photoURL; $('#fabAva').innerHTML=''; $('#fabAva').appendChild(i); }
  closeOverlay($('#ovAuth'));
  toast('Profilo aggiornato');
});

/* ========= AVATAR FULL ========= */
document.body.addEventListener('click', (e)=>{
  const av = e.target.closest('.avatar[data-full]');
  if (!av) return;
  const url = av.dataset.full;
  if (!url) return;
  $('#photoFull img').src = url;
  $('#photoFull').style.display='flex';
});
$('#photoFull').onclick = ()=> $('#photoFull').style.display='none';

/* ========= CHAT TAVOLO ========= */
function listenTable(){
  if (unsubTable) db.ref(tablePath).off('child_added', unsubTable);
  tablePath = 'chats/table/'+keyify(currentUser.tavolo)+'/messages';
  const list = $('#tableMessages'); list.innerHTML='';
  unsubTable = db.ref(tablePath).on('child_added', snap=>{
    const m = snap.val();
    const row = renderMsg(m, m.uid===currentUser.id);
    // se √® un messaggio ‚Äúesterno‚Äù aggiungi bottone rispondi
    if (m.fromName && m.fromId && m.uid!==currentUser.id){
      const btn = document.createElement('button');
      btn.className='btn soft small';
      btn.textContent='Rispondi in privato';
      btn.onclick = ()=> openDMChat({id:m.fromId, nome:m.fromName, tavolo:m.fromTable, emoji:m.fromEmoji, photoURL:m.fromPhoto});
      row.querySelector('.bubble').appendChild(document.createElement('br'));
      row.querySelector('.bubble').appendChild(btn);
    }
    list.appendChild(row); list.scrollTop = list.scrollHeight;
  });
}

$('#tableSend').onclick = async ()=>{
  const v = $('#tableInput').value.trim(); if(!v) return;
  const m = baseMessage(v);
  await db.ref(tablePath).push(m);
  $('#tableInput').value='';
};

/* ========= MESSAGGIO ESTERNO verso tavoli (dal search) ========= */
async function sendExternalToTable(tableName, text){
  const path = 'chats/table/'+keyify(tableName)+'/messages';
  const m = {
    ...baseMessage(text),
    fromId: currentUser.id,
    fromName: currentUser.nome,
    fromTable: currentUser.tavolo,
    fromEmoji: currentUser.emoji||'',
    fromPhoto: currentUser.photoURL||'',
  };
  await db.ref(path).push(m);
  toast('Messaggio inviato a ' + tableName);
}

/* ========= DM ========= */
function dmId(a,b){ return [a,b].sort().join('__'); }

async function openDMChat(user){
  dmPeer = user;
  const id = dmId(currentUser.id, user.id);
  dmIdOpen = id;
  $('#dmWindow').innerHTML='';
  const path = 'chats/dm/'+id+'/messages';
  if (unsubDM) db.ref(path).off('child_added', unsubDM);
  unsubDM = db.ref(path).on('child_added', snap=>{
    const m = snap.val();
    $('#dmWindow').appendChild(renderMsg(m, m.uid===currentUser.id));
    $('#dmWindow').scrollTop = $('#dmWindow').scrollHeight;
  });
  // mark elenco
  refreshDMList();
}

$('#dmSend').onclick = async ()=>{
  if (!dmPeer) return;
  const v = $('#dmInput').value.trim(); if(!v) return;
  const path = 'chats/dm/'+dmIdOpen+'/messages';
  await db.ref(path).push(baseMessage(v));
  // update meta
  await db.ref('chats/dm/'+dmIdOpen+'/meta').set({a:currentUser.id,b:dmPeer.id,ts:now(), last:v});
  $('#dmInput').value='';
};

async function refreshDMList(){
  const list = $('#dmList'); list.innerHTML='';
  const myId = currentUser?.id; if(!myId) return;
  const snap = await db.ref('chats/dm').get();
  let items=[];
  snap.forEach(ch=>{
    const meta = ch.child('meta').val();
    if (!meta) return;
    if (meta.a===myId || meta.b===myId){
      const otherId = meta.a===myId ? meta.b : meta.a;
      items.push({id:ch.key, ts:meta.ts||0, otherId});
    }
  });
  // ordina per ultimo messaggio
  items.sort((a,b)=>b.ts-a.ts);
  if (!items.length) { $('#dmEmpty').style.display='block'; return; }
  $('#dmEmpty').style.display='none';

  // carica utenti
  for (const it of items){
    const us = await db.ref('users/'+it.otherId).get();
    if (!us.exists()) continue;
    const u = us.val();
    const row = document.createElement('div');
    row.className='dmItem';
    const ava = avatarEl(u);
    const right = document.createElement('div');
    right.innerHTML = `<div style="font-weight:700">${u.nome} ${u.emoji||''} ‚Äî <span class="muted small">${u.tavolo||''}</span></div>`;
    row.appendChild(ava); row.appendChild(right);
    row.onclick = ()=> openDMChat({id:it.otherId, ...u});
    list.appendChild(row);
  }
}

/* ========= BRINDISI ========= */
const BRINDISI_USERS = [
 'Brinda in rima per gli sposi','Fai un brindisi dialettale!','Brinda con il vicino di sedia',
 'Brinda guardando negli occhi','Brinda nominando i genitori degli sposi','Fai un brindisi come un telecronista',
 'Brinda come un poeta','Brinda raccontando un aneddoto buffo (30s)','Brinda cantando una parola del brindisi',
 'Brinda citando una canzone famosa'
];
const BRINDISI_TABLES = [
 'Tutti in piedi e brindisi con fazzoletto!','Brindisi al tavolo accanto','Brindisi ‚Äúcall & response‚Äù (una parola a testa)',
 'Brindisi a staff cucina/sala','Brindisi per il tavolo degli sposi','Brindisi in rima per il tavolo'
];

let brindisiTarget = null; // {type:'user'|'table', id, name}

$('#btnBrindisi').onclick = ()=> openSearch('brindisi');

function openBrindisiPicker(){
  $('#bErr').textContent='';
  $('#brindisiTitle').textContent = brindisiTarget.type==='table' ? ('Proponi brindisi a '+brindisiTarget.name) : ('Proponi brindisi a '+brindisiTarget.name);
  fillBrindisiGrid();
  openOverlay($('#ovBrindisi'));
}
function fillBrindisiGrid(){
  const arr = brindisiTarget.type==='table' ? BRINDISI_TABLES : BRINDISI_USERS;
  const g = $('#bGrid'); g.innerHTML='';
  randPick(arr.slice(), 4).forEach(t=>{
    const b = document.createElement('button'); b.className='btn soft'; b.textContent=t; b.onclick=()=>{$('#bCustom').value=t;};
    g.appendChild(b);
  });
}
$('#bShuffle').onclick = fillBrindisiGrid;

$('#bCancel').onclick = ()=> closeOverlay($('#ovBrindisi'));
$('#bSend').onclick = async ()=>{
  const text = $('#bCustom').value.trim();
  if(!text){ $('#bErr').textContent='Scegli un suggerimento o scrivi la tua sfida.'; return; }

  // cooldown mittente (60s) + cooldown ricezione target (180s)
  const cdSendKey = 'cd_send_'+currentUser.id;
  if (Number(localStorage.getItem(cdSendKey)) > now()){ $('#bErr').textContent='Calma! Puoi inviare un brindisi ogni 60s.'; return; }
  const cdRecvKey = brindisiTarget.type==='table' ? ('cd_table_'+brindisiTarget.id) : ('cd_user_'+brindisiTarget.id);
  if (Number(localStorage.getItem(cdRecvKey)) > now()){ $('#bErr').textContent='Quel destinatario ha gi√† ricevuto una sfida di recente.'; return; }

  const payload = { text, from:currentUser.id, fromName:currentUser.nome, fromTable:currentUser.tavolo, ts:now() };
  if (brindisiTarget.type==='table'){
    await db.ref('brindisi/table/'+brindisiTarget.id).push(payload);
  }else{
    await db.ref('brindisi/user/'+brindisiTarget.id).push(payload);
  }

  localStorage.setItem(cdSendKey, String(now()+60000));
  localStorage.setItem(cdRecvKey, String(now()+180000));
  closeOverlay($('#ovBrindisi'));
  toast('Sfida brindisi inviata!');
};

/* ricezione brindisi ‚Äúin app‚Äù (banner nella chat corrente) */
function listenBrindisi(){
  // user inbox
  db.ref('brindisi/user/'+currentUser.id).on('child_added', snap=>{
    const b = snap.val();
    // mostra come messaggio nella finestra attiva (tavolo di default)
    const text = `üçæ ${b.fromName} ‚Äî ${b.fromTable} ti propone un brindisi: ‚Äú${b.text}‚Äù`;
    const m = baseMessage(text); m.fromName=b.fromName; m.fromId=b.from; // permette il bottone rispondi
    $('#tableMessages').appendChild(renderMsg(m,false));
    $('#tableMessages').scrollTop = $('#tableMessages').scrollHeight;
  });
  // table inbox
  db.ref('brindisi/table/'+keyify(currentUser.tavolo)).on('child_added', snap=>{
    const b = snap.val();
    const text = `üçæ ${b.fromName} ‚Äî ${b.fromTable} propone: ‚Äú${b.text}‚Äù`;
    const m = baseMessage(text); m.fromName=b.fromName; m.fromId=b.from;
    $('#tableMessages').appendChild(renderMsg(m,false));
    $('#tableMessages').scrollTop = $('#tableMessages').scrollHeight;
  });
}

/* ========= ANNUNCI STAFF ========= */
$('#btnAnnuncio').onclick = ()=> openOverlay($('#ovAnnuncio'));
$('#annCancel').onclick = ()=> closeOverlay($('#ovAnnuncio'));
$('#annSend').onclick = async ()=>{
  const t = $('#annText').value.trim(); if(!t) return;
  const aRef = await db.ref('annunci/all').push({ text:t, ts:now(), by:currentUser.nome||'staff' });
  $('#annText').value=''; closeOverlay($('#ovAnnuncio')); toast('Annuncio inviato');
};
function listenAnnouncements(){
  db.ref('annunci/all').on('child_added', snap=>{
    const a = snap.val(); const id = snap.key;
    const seenKey = 'ann_seen_'+id;
    if (localStorage.getItem(seenKey)) return;
    // mostra banner
    toast('üì¢ ' + a.text);
    localStorage.setItem(seenKey, '1');
  });
}

/* ========= RICERCA ========= */
$('#btnNewChat').onclick = ()=> openSearch('dm');
function openSearch(mode){ // mode: 'dm' | 'brindisi' | 'msgToTable'
  $('#searchTitle').textContent = mode==='brindisi' ? 'Cerca ospite o tavolo per Brindisi' : 'Cerca ospite o tavolo';
  $('#sQuery').value=''; $('#sResults').innerHTML='';
  $('#sQuery').oninput = ()=> doSearch(mode);
  $('#sClose').onclick = ()=> closeOverlay($('#ovSearch'));
  $('#ovSearch').dataset.mode = mode;
  openOverlay($('#ovSearch'));
  $('#sQuery').focus();
}

async function doSearch(mode){
  const q = $('#sQuery').value.trim().toLowerCase();
  const box = $('#sResults'); box.innerHTML='';
  if (!q) return;

  // utenti
  const usSnap = await db.ref('users').get();
  const users = [];
  usSnap.forEach(s=>{ users.push({id:s.key, ...s.val()}); });

  // tavoli predefiniti 1..10 (o da utenti)
  const tablesSet = new Set(users.map(u=>u.tavolo));
  const tables = Array.from(tablesSet);

  // match: se la query contiene ‚Äútavolo X‚Äù o equiv. allora mostra il tavolo e TUTTI gli ospiti di quel tavolo
  const byTable = tables.filter(t => t.toLowerCase().includes(q));
  const byName  = users.filter(u => u.nome.toLowerCase().includes(q));

  // se c'√® un tavolo trovato, mostra quello e tutti gli ospiti
  if (byTable.length){
    for (const tName of byTable){
      const row = document.createElement('div');
      row.className='dmItem'; row.innerHTML=`<div class="avatar">T</div><div><b>${tName}</b></div>`;
      row.onclick = ()=>{
        closeOverlay($('#ovSearch'));
        if (mode==='brindisi'){ brindisiTarget={type:'table', id:keyify(tName), name:tName}; openBrindisiPicker(); }
        else { // messaggio al tavolo
          // chiedi testo e invia nel canale tavolo
          const txt = prompt('Messaggio al tavolo '+tName+':'); if (!txt) return;
          sendExternalToTable(tName, txt);
        }
      };
      box.appendChild(row);
      // elenco ospiti di quel tavolo (tutti)
      users.filter(u=>u.tavolo===tName).forEach(u=>{
        const r2 = document.createElement('div');
        r2.className='dmItem';
        r2.appendChild(avatarEl(u));
        const info = document.createElement('div');
        info.innerHTML = `<b>${u.nome}</b> ${u.emoji||''} ‚Äî <span class="muted small">${u.tavolo}</span>`;
        r2.appendChild(info);
        r2.onclick = ()=>{
          closeOverlay($('#ovSearch'));
          if (mode==='brindisi'){ brindisiTarget={type:'user', id:u.id||keyify(u.nome), name:u.nome}; openBrindisiPicker(); }
          else openDMChat({id:u.id||keyify(u.nome), ...u});
        };
        box.appendChild(r2);
      });
    }
  }

  // se ci sono match di nome (e NON gi√† elencati sopra) aggiungili
  byName.forEach(u=>{
    // evita duplicati se gi√† mostrato nel blocco tavolo
    if (byTable.some(t=>t===u.tavolo)) return;
    const r = document.createElement('div');
    r.className='dmItem'; r.appendChild(avatarEl(u));
    const info = document.createElement('div');
    info.innerHTML = `<b>${u.nome}</b> ${u.emoji||''} ‚Äî <span class="muted small">${u.tavolo}</span>`;
    r.appendChild(info);
    r.onclick = ()=>{
      closeOverlay($('#ovSearch'));
      if (mode==='brindisi'){ brindisiTarget={type:'user', id:u.id||keyify(u.nome), name:u.nome}; openBrindisiPicker(); }
      else openDMChat({id:u.id||keyify(u.nome), ...u});
    };
    box.appendChild(r);
  });
}

/* ========= RENDER ========= */
function avatarEl(u){
  const a = document.createElement('div');
  a.className='avatar'; a.textContent=(u.nome||'?').substring(0,1).toUpperCase();
  if (u.photoURL){ const i=document.createElement('img'); i.src=u.photoURL; a.innerHTML=''; a.appendChild(i); a.dataset.full=u.photoURL; a.setAttribute('data-full',u.photoURL); a.setAttribute('data-full',''); a.setAttribute('data-full',u.photoURL); a.setAttribute('data-full',''+u.photoURL); a.dataset.full=u.photoURL; a.setAttribute('data-full',u.photoURL); a.setAttribute('data-full',u.photoURL); a.setAttribute('data-full',u.photoURL); a.dataset.full=u.photoURL; a.setAttribute('data-full',u.photoURL); }
  a.setAttribute('data-full', u.photoURL||'');
  return a;
}
function renderMsg(m, me){
  const row = document.createElement('div');
  row.className = 'msg'+(me?' me':'');
  const av = avatarEl({nome:m.fromName||m.name||currentUser.nome, photoURL:m.photoURL||m.fromPhoto});
  row.appendChild(av);
  const b = document.createElement('div'); b.className='bubble';
  b.innerHTML = escapeHtml(m.text || m.body || '');
  row.appendChild(b);
  return row;
}
function baseMessage(text){
  return {
    text, ts:now(),
    uid: currentUser.id,
    name: currentUser.nome,
    photoURL: currentUser.photoURL||'',
    emoji: currentUser.emoji||'',
    table: currentUser.tavolo
  };
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ========= CHAT TAVOLO / PRIVATE pulsanti header ========= */
$('#btnNewChat').onclick = ()=> openSearch('dm');

/* ========= START ========= */
show('home');
$('#tabDMs').classList.add('active');
$('#tabTable').classList.remove('active');

/* ascolti generali se loggato */
function startLogged(){
  listenBrindisi();
}

/* ===== Annunci una sola volta gi√† gestiti con localStorage ===== */

</script>
</body>
</html>