<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Chat Matrimonio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f6f7; --card:#ffffff; --ink:#111; --muted:#666; --brand:#0b0b0c;
      --pill:#111; --pillText:#fff; --accent:#111; --ok:#0a7f3f; --err:#b00020;
      --chip:#efefef; --line:#e8e8ea;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.06);padding:20px}
    h1{margin:0 0 12px;font-size:28px}
    p{margin:8px 0;color:var(--muted);line-height:1.5}

    .home{display:flex;min-height:100dvh;align-items:center;justify-content:center}
    .home .card{max-width:560px;text-align:center}

    .btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
    .btn.primary{background:#111;color:#fff}
    .btn.ghost{background:#eee;color:#111}
    .btn.block{display:block;width:100%}
    .btn.small{padding:8px 12px;border-radius:8px;font-weight:600}
    .row{display:flex;gap:12px}
    .col{display:flex;flex-direction:column;gap:12px}
    .mt16{margin-top:16px}
    .mt24{margin-top:24px}
    .hide{display:none !important}

    /* App chrome */
    header{display:flex;align-items:center;gap:10px;padding:10px}
    header .title{font-weight:700}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{padding:8px 12px;border-radius:16px;background:#eee;cursor:pointer;font-weight:600}
    .tab.active{background:#111;color:#fff}
    .actions{display:flex;gap:8px;margin-left:8px}
    .chip{background:var(--chip);border-radius:10px;padding:6px 10px;color:#111}
    .sep{height:1px;background:var(--line);margin:8px 0}

    /* Layout chat */
    .app{display:flex;flex-direction:column;min-height:100dvh}
    .content{display:grid;grid-template-columns:280px 1fr;gap:12px;padding:12px}
    .list{background:var(--card);border-radius:12px;padding:8px;min-height:60vh}
    .list h3{margin:6px 8px 6px;font-size:14px;color:var(--muted)}
    .dm-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
    .dm-item:hover{background:#f1f1f3}
    .avatar{width:28px;height:28px;border-radius:50%;background:#ddd;display:inline-flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#555;overflow:hidden}
    .room{background:var(--card);border-radius:12px;display:flex;flex-direction:column;min-height:60vh}
    .room-head{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--line)}
    .room-body{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{display:flex;gap:8px;align-items:flex-start}
    .bubble{background:#f3f3f5;border:1px solid #ececef;color:#111;padding:8px 10px;border-radius:10px;max-width:70%}
    .you .bubble{background:#111;color:#fff;border-color:#111;margin-left:auto}
    .sys .bubble{background:#fff7d5;border-color:#ffe484}
    .room-send{display:flex;gap:8px;border-top:1px solid var(--line);padding:8px}
    input[type=text], input[type=password], select, textarea{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;outline:0}
    .ghost-btn{background:#eee;border-radius:8px;padding:6px 8px;cursor:pointer}

    /* Floating profile button */
    .fab-prof{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid #e5e5e8;border-radius:999px;padding:6px 8px;display:flex;align-items:center;gap:8px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .fab-prof .avatar{width:22px;height:22px}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .modal{background:#fff;border-radius:14px;max-width:520px;width:100%;padding:16px}
    .modal h3{margin:6px 0 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .search{padding:10px;border:1px solid #ddd;border-radius:10px;margin-bottom:8px}

    /* Profilo */
    .profile{max-width:520px;margin:0 auto}
    .pf-header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .pf-emoji{display:grid;grid-template-columns:auto 1fr;row-gap:8px;column-gap:10px;align-items:center}
    .pf-emoji .btn.small{width:44px;justify-content:center}
    .hint{color:var(--muted);font-size:13px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    @media (max-width:860px){
      .content{grid-template-columns:1fr}
      .list{order:2}
      .room{order:1}
    }
  </style>
</head>
<body>

<!-- ===== HOME ===== -->
<section id="home" class="home">
  <div class="wrap">
    <div class="card">
      <div class="avatar" style="width:36px;height:36px;margin:0 auto 8px;background:#111;color:#fff">EF</div>
      <h1>Benvenuto üéâ</h1>
      <p>Qui puoi <b>conoscere e chattare con gli altri invitati del matrimonio</b>.</p>
      <p>Puoi lanciare un <b>brindisi speciale</b> ü•Ç per rompere il ghiaccio,<br/>
         oppure aprire una <b>chat privata</b> üíå per parlare direttamente con chi vuoi.<br/>
         Se preferisci, c‚Äô√® anche la chat del tuo tavolo.</p>
      <p><b>Nota:</b> tutto quello che succede qui si cancella dopo <b>72 ore</b>‚Ä¶ quindi divertiti e lasciati andare üòâ</p>

      <div class="row mt24" style="justify-content:center;flex-wrap:wrap;gap:10px">
        <button id="btnNew" class="btn primary">Crea nuovo profilo</button>
        <button id="btnReturn" class="btn ghost">Rientra nel tuo profilo</button>
      </div>
    </div>
  </div>
</section>

<!-- ===== APP ===== -->
<section id="app" class="app hide">
  <header>
    <div class="title"><span id="meBadge" class="chip">‚Ä¶</span></div>

    <!-- Tabs (default: Private) -->
    <div class="tabs">
      <div id="tabDMs" class="tab active">Private</div>
      <div id="tabTable" class="tab">Tavolo</div>
    </div>

    <!-- Actions a destra: Brindisi / Annunci / Nuova chat -->
    <div class="actions">
      <button id="btnBrindisi" class="btn small" title="Proponi brindisi">üçæ</button>
      <button id="btnAnnuncio" class="btn small hide" title="Annuncio a tutti">üì£</button>
      <button id="btnNewDM" class="btn small" title="Nuova chat">‚ûï</button>
    </div>
  </header>

  <div class="content">
    <!-- Elenco DM -->
    <aside class="list" id="dmList">
      <h3>Le tue chat</h3>
      <div id="dmItems"></div>
      <div class="sep"></div>
      <button id="btnNewDM2" class="btn ghost block">Nuova chat privata</button>
    </aside>

    <!-- Finestra chat -->
    <div class="room">
      <div class="room-head">
        <div id="roomAvatar" class="avatar">?</div>
        <div style="font-weight:700" id="roomTitle">Seleziona una chat‚Ä¶</div>
        <div class="chip" id="roomSub" style="margin-left:auto"></div>
      </div>
      <div class="room-body" id="chatWindow"></div>
      <div class="room-send">
        <input id="msgInput" type="text" placeholder="Scrivi un messaggio‚Ä¶" />
        <button id="btnSend" class="btn primary">Invia</button>
      </div>
    </div>
  </div>
</section>

<!-- FAB profilo -->
<button id="fabProfile" class="fab-prof hide">
  <div class="avatar" id="meAvatar"></div><div>Profilo</div>
</button>

<!-- ===== OVERLAY: login/return/profile/search/brindisi ===== -->
<div id="ov" class="overlay"><div id="ovBox" class="modal"></div></div>

<script type="module">
  /* ====================== Firebase ======================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import {
    getDatabase, ref, child, set, get, push, onChildAdded, onValue, update,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAGGNy0N_jMbJ-8JKWTTLU-qT3M9XO",
    authDomain: "chat-matrimonio.firebaseapp.com",
    projectId: "chat-matrimonio",
    storageBucket: "chat-matrimonio.appspot.com",
    messagingSenderId: "533930991153",
    appId: "1:533930991153:web:d4c47af448e6ebfce73f10",
    databaseURL: "https://chat-matrimonio-default-rtdb.europe-west1.firebasedatabase.app"
  };

  const appFB = initializeApp(firebaseConfig);
  const db = getDatabase(appFB);
  const storage = getStorage(appFB);

  /* ====================== Stato locale ======================= */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  let currentUser = null;        // {nome, tavolo, pin, emoji, optOutBrindisi, pfp}
  let currentRoom = null;        // {type:'dm'|'table', id: 'tavolo1' | dmId, title, otherUser?}
  let dmUnsubs = {};             // listeners dm
  let tableUnsub = null;         // listener tavolo
  const TABLES = [1,2,3,4,5,6,7,8,9,10]; // fittizi

  /* ====================== Util ======================= */
  const keyify = s => (s||'').toLowerCase().trim().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  const dmIdFor = (a,b) => ['dm', keyify(a), keyify(b)].sort().join('_'); // simmetrico
  const now = () => Date.now();

  const toast = (msg, ok=true) => {
    const b = document.createElement('div');
    b.className = 'card';
    b.style.position='fixed'; b.style.left='50%'; b.style.top='20px'; b.style.transform='translateX(-50%)';
    b.style.zIndex=50; b.style.padding='10px 14px'; b.style.fontWeight='600';
    b.style.border = `1px solid ${ok?'#cfe9d8':'#f6c0c0'}`;
    b.style.background = ok?'#eaf7f0':'#fdeeee'; b.style.color= ok?'#0b6b3f':'#8a0e0e';
    b.textContent = msg; document.body.appendChild(b); setTimeout(()=>b.remove(), 2200);
  };

  const show = id => { $('#home').classList.add('hide'); $('#app').classList.add('hide'); $(id).classList.remove('hide'); };
  const openOverlay = html => { $('#ovBox').innerHTML = html; $('#ov').style.display='flex'; };
  const closeOverlay = () => { $('#ov').style.display='none'; $('#ovBox').innerHTML=''; };

  const setActiveTab = (tab) => {
    // default: Private
    $('#tabDMs').classList.toggle('active', tab==='dms');
    $('#tabTable').classList.toggle('active', tab==='table');
    if(tab==='dms'){ $('.list').classList.remove('hide'); }
    else { $('.list').classList.add('hide'); }
  };

  /* ====================== HOME BTN ======================= */
  $('#btnNew').onclick = () => openNewProfile();
  $('#btnReturn').onclick = () => openReturn();

  /* ====================== FAB profilo ======================= */
  $('#fabProfile').onclick = () => openProfile();

  /* ====================== Tabs / Actions ======================= */
  $('#tabDMs').onclick = ()=>{ setActiveTab('dms'); openDefaultDM(); };
  $('#tabTable').onclick = ()=>{ setActiveTab('table'); openTableChat(currentUser?.tavolo); };

  $('#btnNewDM').onclick = openDMSearch;
  $('#btnNewDM2').onclick = openDMSearch;

  $('#btnBrindisi').onclick = ()=> openBrindisiTarget();
  // Annuncio solo staff
  const isStaff = (u)=> u && (u.staff === true || keyify(u.nome)==='federico'); // semplice: sposo + flag staff
  $('#btnAnnuncio').onclick = ()=> openAnnuncio();

  /* ====================== LOGIN / PROFILO ======================= */

  function openNewProfile(){
    const optionsTables = TABLES.map(t=>`<option value="${t}">Tavolo ${t}</option>`).join('');
    openOverlay(`
      <div class="modal">
        <h3>Crea nuovo profilo</h3>
        <div class="col">
          <input id="iNome" type="text" placeholder="Nome (es. Giulia R.)">
          <div class="row">
            <input id="iPin" type="password" inputmode="numeric" maxlength="4" placeholder="PIN (4 cifre)" style="max-width:180px">
            <select id="iTav" style="max-width:180px"><option value="">Seleziona tavolo</option>${optionsTables}</select>
          </div>

          <div class="sep"></div>

          <div class="pf-emoji">
            <button class="btn small" data-e="üíç">üíç</button><div>Impegnato/a</div>
            <button class="btn small" data-e="üí¨">üí¨</button><div>Disponibile a chiacchierare</div>
            <button class="btn small" data-e="üéâ">üéâ</button><div>Voglia di far festa</div>
            <button class="btn small" data-e="‚ú®">‚ú®</button><div>Sorprendimi</div>
          </div>
          <div class="hint">Scegli uno status (opzionale).</div>

          <div class="row">
            <label class="row" style="gap:8px;align-items:center">
              <input id="iOpt" type="checkbox"> üôà Non ricevere sfide private (brindisi)
            </label>
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn ghost" id="x">Chiudi</button>
            <button class="btn primary" id="ok">Crea</button>
          </div>
        </div>
      </div>
    `);
    let selEmoji = null;
    $$('.pf-emoji .btn').forEach(b=> b.onclick=()=>{ selEmoji = b.dataset.e; $$('.pf-emoji .btn').forEach(x=>x.style.outline=''); b.style.outline='2px solid #111'; });

    $('#x').onclick = closeOverlay;
    $('#ok').onclick = async ()=>{
      const nome = $('#iNome').value.trim();
      const pin = $('#iPin').value.trim();
      const tav = $('#iTav').value.trim();
      const opt = $('#iOpt').checked;
      if(!nome || !pin.match(/^\d{4}$/) || !tav){ toast('Compila nome, PIN e tavolo', false); return; }
      const key = keyify(nome);
      const exists = await get(ref(db, `users/${key}`));
      if(exists.exists()){ toast('Nome gi√† usato: aggiungi un\'iniziale del cognome', false); return; }
      const user = { nome, pin, tavolo:`${tav}`, emoji: selEmoji||null, optOutBrindisi: !!opt, pfp:null, staff:false, createdAt: now() };
      await set(ref(db, `users/${key}`), user);
      currentUser = user;
      closeOverlay();
      afterLogin();
    };
  }

  function openReturn(){
    const optionsTables = TABLES.map(t=>`<option value="${t}">Tavolo ${t}</option>`).join('');
    openOverlay(`
      <div class="modal">
        <h3>Rientra nel tuo profilo</h3>
        <div class="col">
          <input id="rNome" type="text" placeholder="Nome">
          <div class="row">
            <input id="rPin" type="password" inputmode="numeric" maxlength="4" placeholder="PIN (4 cifre)" style="max-width:180px">
            <select id="rTav" style="max-width:180px"><option value="">Seleziona tavolo</option>${optionsTables}</select>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn ghost" id="x">Chiudi</button>
            <button class="btn primary" id="ok">Entra</button>
          </div>
        </div>
      </div>
    `);
    $('#x').onclick = closeOverlay;
    $('#ok').onclick = async ()=>{
      const nome = $('#rNome').value.trim(); const pin=$('#rPin').value.trim(); const tav=$('#rTav').value.trim();
      if(!nome || !pin.match(/^\d{4}$/) || !tav){ toast('Compila nome, PIN e tavolo', false); return; }
      const snap = await get(ref(db, `users/${keyify(nome)}`));
      if(!snap.exists()){ toast('Profilo non trovato', false); return; }
      const u = snap.val();
      if(u.pin!==pin || `${u.tavolo}`!==`${tav}`){ toast('Dati non corretti', false); return; }
      currentUser = u;
      closeOverlay();
      afterLogin();
    };
  }

  async function openProfile(){
    if(!currentUser){ return; }
    const u = currentUser;
    openOverlay(`
      <div class="modal profile">
        <div class="pf-header">
          <div class="avatar" id="pfAvatar">${initials(u.nome)}</div>
          <div><div style="font-weight:700">${u.nome}</div><div class="hint">Tavolo ${u.tavolo}</div></div>
        </div>

        <div class="col">
          <label class="hint">Cambia/aggiungi foto profilo</label>
          <input id="pfFile" type="file" accept="image/*" capture="environment">
          <div class="sep"></div>

          <label class="hint">Emoji / Status</label>
          <div class="pf-emoji">
            <button class="btn small" data-e="üíç">üíç</button><div>Impegnato/a</div>
            <button class="btn small" data-e="üí¨">üí¨</button><div>Disponibile a chiacchierare</div>
            <button class="btn small" data-e="üéâ">üéâ</button><div>Voglia di far festa</div>
            <button class="btn small" data-e="‚ú®">‚ú®</button><div>Sorprendimi</div>
          </div>

          <label class="row" style="gap:8px;align-items:center"><input id="pfOpt" type="checkbox"> üôà Non ricevere sfide private</label>

          <div class="row" style="justify-content:flex-end">
            <button class="btn ghost" id="x">Indietro</button>
            <button class="btn primary" id="save">Salva</button>
          </div>
          <div id="pfMsg" class="hint"></div>
        </div>
      </div>
    `);
    // preselezione
    $$('.pf-emoji .btn').forEach(b=>{
      if(b.dataset.e===u.emoji){ b.style.outline='2px solid #111'; }
      b.onclick=()=>{ $$('.pf-emoji .btn').forEach(x=>x.style.outline=''); b.style.outline='2px solid #111'; u.emoji=b.dataset.e; };
    });
    $('#pfOpt').checked = !!u.optOutBrindisi;

    $('#x').onclick = closeOverlay;
    $('#save').onclick = async ()=>{
      try{
        $('#pfMsg').textContent = 'Salvo‚Ä¶';
        const files = $('#pfFile').files;
        if(files && files[0]){
          const file = files[0];
          const p = `pfp/${u.tavolo}/${keyify(u.nome)}.jpg`;
          const r = sRef(storage, p);
          await uploadBytes(r, file);
          u.pfp = await getDownloadURL(r);
        }
        u.optOutBrindisi = $('#pfOpt').checked;
        await update(ref(db, `users/${keyify(u.nome)}`), { emoji:u.emoji||null, optOutBrindisi: u.optOutBrindisi, pfp: u.pfp||null });
        currentUser = (await get(ref(db, `users/${keyify(u.nome)}`))).val();
        fillMeUI();
        $('#pfMsg').innerHTML = '<span class="ok">Salvato</span>';
        setTimeout(closeOverlay, 700);
      }catch(e){
        $('#pfMsg').innerHTML = '<span class="err">Errore salvataggio</span>';
      }
    };
  }

  function initials(n){ return (n||'?').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase(); }

  /* ====================== Dopo login ======================= */
  function afterLogin(){
    show('#app');
    $('#fabProfile').classList.remove('hide');
    $('#btnAnnuncio').classList.toggle('hide', !isStaff(currentUser));
    fillMeUI();
    setActiveTab('dms');     // **apriamo sulle Private**
    openDefaultDM();         // seleziona ultima/nessuna
    // listener elenco DM
    listenDMIndex();
  }

  function fillMeUI(){
    $('#meBadge').textContent = `${currentUser.nome} ${currentUser.emoji||''} ‚Äî Tavolo ${currentUser.tavolo}`;
    $('#meAvatar').textContent = '';
    $('#meAvatar').style.background = '#ddd';
    $('#meAvatar').innerText = (currentUser.pfp?'':initials(currentUser.nome));
    if(currentUser.pfp){ $('#meAvatar').style.backgroundImage=`url(${currentUser.pfp})`; $('#meAvatar').style.backgroundSize='cover'; }
  }

  /* ====================== DM: elenco + apertura ======================= */

  function listenDMIndex(){
    const container = $('#dmItems');
    container.innerHTML = '';
    const path = `dmIndex/${keyify(currentUser.nome)}`;
    onValue(ref(db, path), (snap)=>{
      container.innerHTML='';
      const val = snap.val()||{};
      const rows = Object.entries(val).sort((a,b)=> (b[1].ts||0)-(a[1].ts||0));
      if(!rows.length){ container.innerHTML = `<div class="hint" style="padding:6px 8px">Nessuna chat privata. Premi ‚ÄúNuova chat‚Äù.</div>`; return; }
      rows.forEach(([other, meta])=>{
        const row = document.createElement('div'); row.className='dm-item';
        row.innerHTML = `<div class="avatar">${(meta.pfp?'<img src="'+meta.pfp+'" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>':initials(other))}</div>
                         <div><div style="font-weight:700">${other} ${meta.emoji||''}</div>
                         <div class="hint" style="font-size:12px">Ultimo: ${meta.last||''}</div></div>`;
        row.onclick = ()=> openDMChat(other);
        container.appendChild(row);
      });
    });
  }

  async function openDefaultDM(){
    $('#roomTitle').textContent='Chat private';
    $('#roomSub').textContent='Apri o crea una chat';
    $('#chatWindow').innerHTML = `<div class="hint" style="padding:12px">Seleziona una chat dall‚Äôelenco o premi ‚ÄúNuova chat privata‚Äù.</div>`;
    $('#msgInput').value=''; $('#msgInput').disabled=true; $('#btnSend').disabled=true;
    // Nessun listener DM attivo
    Object.values(dmUnsubs).forEach(unsub=>unsub && unsub()); dmUnsubs={};
    // Chiudi listener tavolo se c‚Äôera
    if(tableUnsub){ tableUnsub(); tableUnsub=null; }
  }

  async function openDMChat(otherName){
    const you = currentUser.nome; const other = otherName;
    const id = dmIdFor(you, other);
    currentRoom = { type:'dm', id, title: other, otherUser: other };
    setActiveTab('dms');
    $('#roomTitle').textContent = other;
    $('#roomSub').textContent = 'Chat privata';
    $('#roomAvatar').textContent = initials(other);
    $('#msgInput').disabled=false; $('#btnSend').disabled=false;
    $('#chatWindow').innerHTML='';

    // chiudi tavolo & DM listeners precedenti
    if(tableUnsub){ tableUnsub(); tableUnsub=null; }
    if(dmUnsubs[id]){ dmUnsubs[id](); }

    // ascolta messaggi DM
    const msgsRef = ref(db, `dms/${id}/messages`);
    dmUnsubs[id] = onChildAdded(msgsRef, (snap)=>{
      const m = snap.val(); renderMsg(m, m.from===currentUser.nome?'you':'other');
    });

    // aggiorna index per ordinamento
    await update(ref(db, `dmIndex/${keyify(currentUser.nome)}/${other}`), { ts: now() });
  }

  function renderMsg(m, who){
    const row = document.createElement('div');
    row.className = 'msg '+(m.type==='sys'?'sys': who==='you'?'you':'');
    const av = document.createElement('div'); av.className='avatar';
    av.textContent = initials(m.from||'S');
    if(m.pfp){ av.innerHTML = `<img src="${m.pfp}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`; }
    const bub = document.createElement('div'); bub.className='bubble';
    if(m.type==='sys' && m.action==='reply_link'){
      bub.innerHTML = `<div><b>${m.title}</b></div>
                       <div class="hint" style="margin:6px 0">${m.text}</div>
                       <button class="btn small" id="reply_${m.fromKey}">Rispondi in privato</button>`;
      setTimeout(()=>{
        const b = document.getElementById(`reply_${m.fromKey}`);
        if(b) b.onclick = ()=> openDMChat(m.from);
      },0);
    }else{
      bub.textContent = m.text||'';
    }
    row.appendChild(av); row.appendChild(bub);
    $('#chatWindow').appendChild(row);
    $('#chatWindow').scrollTop = $('#chatWindow').scrollHeight;
  }

  /* Invio messaggio */
  $('#btnSend').onclick = async ()=>{
    const txt = $('#msgInput').value.trim(); if(!txt) return;
    $('#msgInput').value='';
    if(!currentRoom) return;

    if(currentRoom.type==='dm'){
      const id = currentRoom.id;
      const m = { text: txt, from: currentUser.nome, pfp: currentUser.pfp||null, ts: now() };
      await push(ref(db, `dms/${id}/messages`), m);
      // aggiorna indici
      await update(ref(db, `dmIndex/${keyify(currentUser.nome)}/${currentRoom.otherUser}`), { ts:m.ts, last:txt, emoji:null, pfp:null });
      await update(ref(db, `dmIndex/${keyify(currentRoom.otherUser)}/${currentUser.nome}`), { ts:m.ts, last:txt, emoji:currentUser.emoji||null, pfp: currentUser.pfp||null });

    }else if(currentRoom.type==='table'){
      const t = currentUser.tavolo;
      const m = { text: txt, from: currentUser.nome, pfp: currentUser.pfp||null, ts: now() };
      await push(ref(db, `tables/${t}/messages`), m);
    }
  };

  /* ====================== Tavolo ======================= */

  function openTableChat(tableId){
    setActiveTab('table');
    currentRoom = { type:'table', id:`${tableId}`, title:`Tavolo ${tableId}` };
    $('#roomTitle').textContent = `Tavolo ${tableId}`;
    $('#roomSub').textContent = 'Chat del tavolo';
    $('#roomAvatar').textContent = 'T';
    $('#msgInput').disabled=false; $('#btnSend').disabled=false;
    $('#chatWindow').innerHTML='';

    // chiudi dm listeners
    Object.values(dmUnsubs).forEach(un=>un && un()); dmUnsubs={};
    // attach tavolo
    if(tableUnsub){ tableUnsub(); }
    const path = `tables/${tableId}/messages`;
    tableUnsub = onChildAdded(ref(db, path), (snap)=>{
      const m = snap.val();
      const who = m.from===currentUser.nome?'you':'other';
      renderMsg(m, who);
    });

    // Mostra eventuali messaggi ‚Äúesterni‚Äù come normali (con pulsante Rispondi)
    const extPath = `tables/${tableId}/incoming`;
    onChildAdded(ref(db, extPath), (snap)=>{
      const e = snap.val();
      // messaggio ‚Äúdi sistema‚Äù con bottone
      const sys = {
        type:'sys', action:'reply_link', from: e.from, fromKey:keyify(e.from),
        title:`Messaggio da ${e.from} ${e.emoji||''} ‚Äî Tavolo ${e.tableFrom||'?'}`,
        text:e.text
      };
      renderMsg(sys, 'other');
    });
  }

  // invio ‚Äúmessaggio al tavolo‚Äù da utente esterno (usato dal picker Cerca)
  async function sendToTableAsExternal(tableId, text, fromMeta){
    const data = { text, from: fromMeta.nome, emoji: fromMeta.emoji||null, tableFrom: fromMeta.tavolo, ts: now() };
    await push(ref(db, `tables/${tableId}/incoming`), data);
  }

  /* ====================== Cerca / Nuova Chat ======================= */

  function openDMSearch(){
    openOverlay(renderSearchModal('dm'));
  }
  function openBrindisiTarget(){
    openOverlay(renderSearchModal('brindisi'));
  }

  function renderSearchModal(mode){
    const title = mode==='brindisi' ? 'Cerca ospite o tavolo per Brindisi' : 'Cerca ospite o tavolo';
    const listTables = TABLES.map(t=>`<div class="dm-item" data-t="t" data-id="${t}"><div class="avatar">T</div><div><b>Tavolo ${t}</b></div></div>`).join('');
    return `
      <div class="modal">
        <h3>${title}</h3>
        <input id="q" class="search" placeholder="Cerca nome o tavolo‚Ä¶" />
        <div style="max-height:50vh;overflow:auto">
          <h3>Tavoli</h3>
          <div id="tList">${listTables}</div>
          <div class="sep"></div>
          <h3>Ospiti</h3>
          <div id="uList"><div class="hint" style="padding:6px 8px">Digita per cercare‚Ä¶</div></div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn ghost" id="close">Chiudi</button>
        </div>
      </div>
    `;
  }

  $('#ov').addEventListener('click', (e)=>{ if(e.target.id==='ov'){ closeOverlay(); }});

  // deleghe overlay
  document.body.addEventListener('click', async (e)=>{
    if(!$('#ov').style.display || $('#ov').style.display==='none') return;

    const t = e.target;

    if(t.id==='close') { closeOverlay(); return; }

    // ricerca (digitazione)
    if(t.id==='q' || t.closest('#q')){
      $('#q').oninput = async ()=>{
        const q = $('#q').value.toLowerCase().trim();
        const uList = $('#uList');
        if(!q){ uList.innerHTML = `<div class="hint" style="padding:6px 8px">Digita per cercare‚Ä¶</div>`; return; }
        // fetch utenti (semplice, tutti)
        const snap = await get(ref(db, `users`));
        const all = snap.val()||{};
        const rows = Object.values(all).filter(u => keyify(u.nome).includes(keyify(q)) || (`tavolo ${u.tavolo}`).includes(q));
        if(!rows.length){ uList.innerHTML = `<div class="hint" style="padding:6px 8px">Nessun risultato</div>`; return;}
        uList.innerHTML = rows.map(u=>(
          `<div class="dm-item" data-t="u" data-id="${u.nome}">
             <div class="avatar">${u.pfp?`<img src="${u.pfp}" style="width:100%;height:100%;object-fit:cover;border-radius:50%"/>`:initials(u.nome)}</div>
             <div><b>${u.nome}</b> ${u.emoji||''}<div class="hint">Tavolo ${u.tavolo}</div></div>
           </div>`
        )).join('');
      };
    }

    // click risultato (tavolo / utente)
    const row = t.closest('.dm-item');
    if(row){
      const typ = row.dataset.t; const val = row.dataset.id;
      // Se overlay √® ‚Äúbrindisi‚Äù, apri picker brindisi
      if($('#ovBox').querySelector('h3')?.textContent.includes('Brindisi')){
        if(typ==='u'){ openBrindisiPick('user', val); }
        else{ openBrindisiPick('table', val); }
        return;
      }
      // Altrimenti √® ‚Äúnuova chat / messaggio‚Äù
      if(typ==='u'){
        closeOverlay(); openDMChat(val);
      }else{
        // scrivi al tavolo (messaggio che resta nel tavolo)
        const name = prompt('Scrivi il messaggio per Tavolo '+val+' (comparir√† nella loro chat):');
        if(!name) return;
        await sendToTableAsExternal(val, name, currentUser);
        toast('Messaggio inviato al Tavolo '+val);
      }
    }
  });

  /* ====================== Brindisi ======================= */

  // cool-down per-sender (60s) + anti-spam semplice per table/utente target
  const cooldownSend = new Map();
  function canSend(kind, target){
    const key = `${kind}:${target}:${keyify(currentUser.nome)}`;
    const last = cooldownSend.get(key)||0;
    if(now()-last < 60000){ return false; }
    cooldownSend.set(key, now()); return true;
  }

  function openBrindisiPick(kind, target){
    const SUG = kind==='table'
      ? ['Tutti in piedi e brindisi con fazzoletto!', 'Brindisi per gli sposi in rima', 'Brindisi al tavolo accanto', 'Brindisi dialettale!']
      : ['Brindisi in rima', 'Brindisi guardandoci negli occhi', 'Brindisi ‚Äúcapitano mio capitano‚Äù (in piedi sulla sedia üòÖ)', 'Brindisi con citazione canzone'];

    openOverlay(`
      <div class="modal">
        <h3>Proponi brindisi a ${kind==='table'?'Tavolo '+target: target}</h3>
        <div class="grid2">
          ${SUG.slice(0,4).map((s,i)=>`<button class="btn ghost" data-sel="s${i}">${s}</button>`).join('')}
        </div>
        <div class="mt16"><input id="free" class="search" placeholder="Oppure scrivi la tua sfida‚Ä¶"/></div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn ghost" id="x">Annulla</button>
          <button class="btn primary" id="sendB">Invia</button>
        </div>
      </div>
    `);

    let chosen = null;
    $$('[data-sel]').forEach(b=> b.onclick=()=>{ chosen=b.textContent; $$('[data-sel]').forEach(x=>x.style.outline=''); b.style.outline='2px solid #111'; });
    $('#x').onclick = closeOverlay;
    $('#sendB').onclick = async ()=>{
      const text = chosen || $('#free').value.trim();
      if(!text){ toast('Scegli o scrivi una sfida', false); return; }
      // cooldown per-sender
      if(!canSend(kind, target)){ toast('Aspetta un attimo prima di inviare un altro brindisi üòâ', false); return; }

      const payload = { from: currentUser.nome, emoji: currentUser.emoji||null, tableFrom: currentUser.tavolo, text, ts: now(), kind };
      if(kind==='table'){
        await push(ref(db, `brindisi/table/${target}`), payload);
      }else{
        await push(ref(db, `brindisi/user/${keyify(target)}`), payload);
      }
      closeOverlay();
      toast('Brindisi inviato!');
    };
  }

  // Ascolto Brindisi destinati a me / al mio tavolo
  function listenBrindisi(){
    // a me
    onChildAdded(ref(db, `brindisi/user/${keyify(currentUser.nome)}`),(snap)=>{
      const b = snap.val();
      // messaggio nella MIA chat privata (con mittente) per invito
      const sys = {
        type:'sys', action:'reply_link', from: b.from, fromKey:keyify(b.from),
        title:`${b.from} ${b.emoji||''} ti propone un brindisi!`,
        text:b.text
      };
      // apri/crea DM con mittente e mostra
      openDMChat(b.from);
      renderMsg(sys,'other');
    });
    // al mio tavolo
    onChildAdded(ref(db, `brindisi/table/${currentUser.tavolo}`),(snap)=>{
      const b = snap.val();
      // mostralo in chat tavolo come mess. sistema con bottone ‚ÄúRispondi in privato‚Äù
      if(currentRoom?.type!=='table') openTableChat(currentUser.tavolo);
      const sys = {
        type:'sys', action:'reply_link', from: b.from, fromKey:keyify(b.from),
        title:`Brindisi per Tavolo ${currentUser.tavolo} da ${b.from} ${b.emoji||''}`,
        text:b.text
      };
      renderMsg(sys,'other');
    });
  }

  /* ====================== Annunci (solo staff) ======================= */
  function openAnnuncio(){
    openOverlay(`
      <div class="modal">
        <h3>Nuovo annuncio (a tutti)</h3>
        <textarea id="annTxt" rows="3" placeholder="Scrivi l‚Äôannuncio‚Ä¶"></textarea>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn ghost" id="x">Annulla</button>
          <button class="btn primary" id="ok">Invia</button>
        </div>
      </div>
    `);
    $('#x').onclick = closeOverlay;
    $('#ok').onclick = async ()=>{
      const t = $('#annTxt').value.trim(); if(!t){ toast('Scrivi qualcosa', false); return; }
      await push(ref(db,'annunci/all'), { text:t, ts:now(), by: currentUser.nome });
      closeOverlay(); toast('Annuncio inviato!');
    };
  }

  // Mostra annunci una sola volta per utente (localStorage)
  (function listenAnnunci(){
    onChildAdded(ref(db,'annunci/all'),(snap)=>{
      const a = snap.val(); const seen = JSON.parse(localStorage.getItem('annSeen')||'[]');
      if(seen.includes(snap.key)) return;
      openOverlay(`
        <div class="modal">
          <h3>Annuncio</h3>
          <p>${a.text}</p>
          <div class="row" style="justify-content:flex-end"><button id="okAnn" class="btn primary">OK</button></div>
        </div>
      `);
      $('#okAnn').onclick = ()=>{ closeOverlay(); localStorage.setItem('annSeen', JSON.stringify(seen.concat(snap.key))); };
    });
  })();

  /* ====================== Start ======================= */
  function boot(){
    const saved = JSON.parse(localStorage.getItem('me')||'null');
    if(saved){ currentUser = saved; afterLogin(); }
  }
  // persistenza semplice
  window.addEventListener('beforeunload', ()=>{ if(currentUser) localStorage.setItem('me', JSON.stringify(currentUser)); });

  boot();
  listenBrindisi();
</script>
</body>
</html>
