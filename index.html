<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Chat Matrimonio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bd:#ddd; --ok:#1a8f3a; --err:#b00020; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#fafafa; color:#111; }
    section { padding:16px; max-width:560px; margin:0 auto; }
    h1,h2,h3 { margin:8px 0; }
    .fld { width:100%; padding:12px; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    .btn { padding:10px 14px; border:none; border-radius:10px; cursor:pointer; }
    .btn.dark { background:#111; color:#fff; }
    .btn.light { background:#eee; }
    .row { display:flex; gap:8px; align-items:center; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .pill { background:#eee; border:none; border-radius:999px; padding:6px 10px; cursor:pointer; }
    .msg { background:#fff; border:1px solid var(--bd); border-radius:10px; padding:8px 10px; }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:999; padding:16px; }
    .sheet { background:#fff; border-radius:14px; padding:16px; width:min(560px, 94vw); max-height:92vh; overflow:auto; }
    .avatar32 { width:32px; height:32px; border-radius:50%; object-fit:cover; background:#f2f2f2; }
    .avatar28 { width:28px; height:28px; border-radius:50%; object-fit:cover; background:#eee; border:1px solid #ddd; flex:0 0 28px; }
    .avatar24 { width:24px; height:24px; border-radius:50%; object-fit:cover; background:#eee; border:1px solid #ddd; }
    .avatarBtn { width:36px; height:36px; border-radius:50%; object-fit:cover; background:#eee; border:1px solid var(--bd); }
    .emojiList { display:flex; flex-direction:column; gap:8px; margin-bottom:12px; }
    .emojiRow { display:flex; align-items:center; gap:12px; width:100%; padding:10px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer; text-align:left; }
    .emojiRow:hover { background:#fafafa; }
    .emojiRow.is-selected { border-color:#111; box-shadow:0 0 0 2px #111 inset; }
    .bigEmoji { font-size:22px; width:26px; text-align:center; }
    .emojiText { font-size:15px; color:#222; }
    .br-sugg { padding:8px 10px; border:1px solid var(--bd); border-radius:10px; background:#fff; cursor:pointer; text-align:left; }
    .br-sugg:hover { background:#fafafa; }
    .badge { background:#111; color:#fff; border-radius:8px; padding:2px 6px; font-size:12px; }
    .imgMsg { max-width:60%; border-radius:10px; display:block; }
    #chatWindow, #dmWindow { background:#fff; border:1px solid var(--bd); border-radius:12px; padding:10px; }
    #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:26px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; display:none; z-index:1000; }
    .msgRow { display:flex; align-items:flex-start; gap:8px; }
    .msgBubble { background:#fff; border:1px solid var(--bd); border-radius:10px; padding:6px 10px; max-width:80%; }
    .msgHeader { font-size:12px; color:#666; margin-bottom:4px; }
    #dmTabs .pill { background:#eee; }
    #dmTabs .pill.active { background:#111; color:#fff; }

    /* HOME polished */
    .hero {
      min-height: 92vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px 16px;
      background: radial-gradient(1200px 600px at 50% -20%, #fff 0, #f7f7f7 60%, #f2f2f2 100%);
    }
    .card {
      width: 100%;
      max-width: 440px;
      background: #fff;
      border: 1px solid var(--bd);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.05);
      padding: 20px 18px;
      text-align: center;
    }
    .appMark { display:inline-flex; align-items:center; gap:8px; font-weight:800; letter-spacing:.3px; margin-bottom:6px; }
    .appMark .logo { width:36px; height:36px; }
    .card h1 { font-size: 26px; margin: 6px 0 12px; }
    .card p  { color:#444; line-height:1.45; margin: 0 0 12px; }
    .actions { display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .actions .btn { width:100%; padding: 14px 16px; font-size:16px; border-radius:12px; }
    .subtle { font-size:12px; color:#777; margin-top:10px; }

    @media (prefers-color-scheme: dark) {
      body { background:#0f0f10; color:#eee; }
      .card { background:#161617; border-color:#2a2a2c; }
      .subtle { color:#aaa; }
      .btn.light { background:#2a2a2c; color:#fff; }
    }
  </style>
</head>
<body>

<!-- HOME -->
<section id="screen-home" class="hero">
  <div class="card">
    <div class="appMark">
      <span class="logo">
        <!-- Logo EF -->
        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 100 100">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#111"/><stop offset="100%" stop-color="#444"/></linearGradient></defs>
          <circle cx="50" cy="50" r="48" fill="url(#g)" />
          <text x="50%" y="55%" text-anchor="middle" font-size="42" font-weight="700" fill="#fff" font-family="system-ui,-apple-system,sans-serif">EF</text>
        </svg>
      </span>
      <span>Chat Matrimonio</span>
    </div>

    <h1>Benvenuto üéâ</h1>

    <p>Qui puoi chiacchierare con il tuo tavolo<br>o conoscere e chattare con altri ospiti.</p>
    <p>Puoi sfidare gli altri a brindisi speciali üçæ<br>oppure aprire chat private üíå per parlare direttamente con chi vuoi.</p>
    <p class="subtle">Tutto ci√≤ che succede qui viene cancellato automaticamente dopo <strong>72 ore</strong> ‚Äî quindi‚Ä¶ buttati!</p>

    <div class="actions">
      <button id="btnCreate" class="btn dark">Crea nuovo profilo</button>
      <button id="btnLogin"  class="btn light">Rientra nel tuo profilo</button>
    </div>
  </div>
</section>

<!-- CREATE -->
<section id="screen-create" style="display:none">
  <h2>Crea il tuo profilo</h2>
  <label>Nome</label>
  <input id="cName" class="fld" placeholder="Es. Federico">
  <label>Tavolo</label>
  <select id="cTable" class="fld">
    <option value="" disabled selected>Seleziona tavolo</option>
    <option>Tavolo 1</option><option>Tavolo 2</option><option>Tavolo 3</option><option>Tavolo 4</option>
  </select>
  <label>PIN (4 cifre)</label>
  <input id="cPin" class="fld" type="password" maxlength="4" placeholder="----">

  <label>Foto profilo</label>
  <input id="cFoto" type="file" accept="image/*,.heic,.HEIC">

  <!-- Emoji bloccate finch√© non compili i 3 campi -->
  <div id="emojiBlock" style="display:none">
    <label style="display:block;margin:8px 0 6px">Emoji / Status</label>
    <div id="emojiList" class="emojiList">
      <button class="emojiRow" data-emoji="üíç" data-label="Impegnato/a"><span class="bigEmoji">üíç</span><span class="emojiText">Impegnato/a</span></button>
      <button class="emojiRow" data-emoji="üòä" data-label="Disponibile a chiacchierare"><span class="bigEmoji">üòä</span><span class="emojiText">Disponibile a chiacchierare</span></button>
      <button class="emojiRow" data-emoji="üéâ" data-label="Voglia di festa"><span class="bigEmoji">üéâ</span><span class="emojiText">Voglia di festa</span></button>
      <button class="emojiRow" data-emoji="ü§î" data-label="Sorprendimi"><span class="bigEmoji">ü§î</span><span class="emojiText">Sorprendimi</span></button>
      <button class="emojiRow" data-emoji="" data-label="Nessuna"><span class="bigEmoji">‚Äî</span><span class="emojiText">Nessuna</span></button>
    </div>
  </div>

  <button id="cSave" class="btn dark" style="margin-top:12px">Continua</button>
  <div id="cMsg" style="margin-top:10px"></div>
</section>

<!-- LOGIN -->
<section id="screen-login" style="display:none">
  <h2>Rientra nel tuo profilo</h2>
  <label>Nome</label>
  <input id="lName" class="fld">
  <label>PIN</label>
  <input id="lPin" class="fld" type="password" maxlength="4" placeholder="----">
  <label>Tavolo</label>
  <select id="lTable" class="fld">
    <option value="" disabled selected>Seleziona tavolo</option>
    <option>Tavolo 1</option><option>Tavolo 2</option><option>Tavolo 3</option><option>Tavolo 4</option>
  </select>
  <button id="lGo" class="btn dark" style="margin-top:12px">Accedi</button>
  <div id="lMsg" style="margin-top:10px;color:var(--err)"></div>
</section>

<!-- CHAT TAVOLO + DM -->
<section id="screen-chat" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div class="row" style="gap:10px">
      <img id="meAvatarBtn" class="avatarBtn" alt="Profilo">
      <h2 id="chatTitle" style="margin:0">Tavolo</h2>
      <span id="meBadge" class="badge" style="display:none">STAFF</span>
    </div>
    <div class="row">
      <div id="dmTabs" class="row" style="gap:0">
        <button id="tabTable" class="pill" style="border-top-right-radius:0;border-bottom-right-radius:0">Tavolo</button>
        <button id="tabDMs"   class="pill" style="border-top-left-radius:0;border-bottom-left-radius:0">Private</button>
      </div>
      <button id="btnNewDM" class="pill" title="Nuova chat privata" style="display:none">‚ûïüí¨</button>
      <button id="btnAnnuncio" class="pill" title="Annuncio" style="display:none">üì¢</button>
      <button id="btnBrindisi" class="pill" title="Brindisi">üçæ</button>
    </div>
  </div>

  <div id="chatWindow" style="margin:10px 0; height:320px; overflow:auto"></div>

  <!-- Lista chat private -->
  <div id="dmList" class="list" style="display:none; margin:10px 0"></div>

  <div class="row">
    <input id="chatInput" class="fld" placeholder="Scrivi un messaggio‚Ä¶">
    <button id="chatPhoto" class="btn light" title="Invia foto">üì∑</button>
    <button id="chatSend" class="btn dark">Invia</button>
  </div>
  <input id="chatPhotoFile" type="file" accept="image/*,.heic,.HEIC" style="display:none">

  <div class="row" style="margin-top:10px; justify-content:space-between">
    <button id="btnLogout" class="btn light">Esci</button>
  </div>
</section>

<!-- PROFILO -->
<section id="screen-profile" style="display:none">
  <h2>Profilo</h2>
  <div class="row" style="gap:12px">
    <img id="pFoto" class="avatar32" style="width:80px;height:80px" alt="">
    <div>
      <div id="pName" style="font-weight:700"></div>
      <div id="pTable" style="color:#666"></div>
      <div id="pFlags" style="margin-top:6px"></div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <button id="pChangeFoto" class="btn light">Cambia/aggiungi foto</button>
    <input id="pFotoInput" type="file" accept="image/*,.heic,.HEIC" style="display:none">
  </div>

  <div style="margin-top:12px">
    <label style="display:block;margin:8px 0 6px">Emoji / Status</label>
    <div id="pEmojiList" class="emojiList">
      <button class="emojiRow" data-emoji="üíç" data-label="Impegnato/a"><span class="bigEmoji">üíç</span><span class="emojiText">Impegnato/a</span></button>
      <button class="emojiRow" data-emoji="üòä" data-label="Disponibile a chiacchierare"><span class="bigEmoji">üòä</span><span class="emojiText">Disponibile a chiacchierare</span></button>
      <button class="emojiRow" data-emoji="üéâ" data-label="Voglia di festa"><span class="bigEmoji">üéâ</span><span class="emojiText">Voglia di festa</span></button>
      <button class="emojiRow" data-emoji="ü§î" data-label="Sorprendimi"><span class="bigEmoji">ü§î</span><span class="emojiText">Sorprendimi</span></button>
      <button class="emojiRow" data-emoji="" data-label="Nessuna"><span class="bigEmoji">‚Äî</span><span class="emojiText">Nessuna</span></button>
    </div>

    <label style="display:flex;align-items:center;gap:8px;margin-top:6px">
      <input id="pOptOut" type="checkbox"> üôä Non ricevere sfide private üçæ
    </label>
  </div>

  <div class="row" style="margin-top:12px">
    <button id="pBack" class="btn light">Indietro</button>
    <button id="pSave" class="btn dark">Salva</button>
  </div>
  <div id="pMsg" style="margin-top:8px"></div>
</section>

<!-- DM CHAT -->
<section id="screen-dm-chat" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center">
    <button id="dmc_back" class="pill">‚¨ÖÔ∏é</button>
    <h2 id="dmTitle" style="margin:8px 0">Chat privata</h2>
    <span></span>
  </div>
  <div id="dmWindow" style="margin:8px 0 12px; height:310px; overflow:auto"></div>
  <div class="row">
    <input id="dmInput" class="fld" placeholder="Scrivi un messaggio‚Ä¶">
    <button id="dmPhoto" class="btn light">üì∑</button>
    <button id="dmSend" class="btn dark">Invia</button>
  </div>
  <input id="dmPhotoFile" type="file" accept="image/*,.heic,.HEIC" style="display:none">
</section>

<!-- OVERLAY: Ricerca -->
<div id="ovlSearch" class="overlay">
  <div class="sheet">
    <h3>Cerca ospite o tavolo</h3>
    <input id="sQuery" class="fld" placeholder="Es. Edoardo oppure Tavolo 3">
    <div id="sResults" class="list" style="margin-top:10px; max-height:300px; overflow:auto"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="sClose" class="btn light">Chiudi</button>
    </div>
  </div>
</div>

<!-- OVERLAY: Brindisi - Step 2 -->
<div id="ovlBrStep2" class="overlay">
  <div class="sheet" style="max-width:560px">
    <h3 id="br2_title">üçæ Brindisi</h3>
    <div id="br2_sub" style="color:#666;margin-top:4px;margin-bottom:10px">Scegli una sfida oppure scrivi la tua.</div>
    <div style="font-weight:600;margin:8px 0 6px" id="br2_label">Proposte per te</div>
    <div id="br2_list" class="list"></div>
    <button id="br2_more" class="pill" style="margin-top:8px">üîÑ Mostra altre</button>
    <input id="br2_free" class="fld" placeholder="‚Ä¶oppure scrivi qui la tua sfida" style="margin-top:10px">
    <div style="font-size:12px;color:#666;margin-top:6px">Dopo l‚Äôinvio dovrai attendere 60s per un altro brindisi.</div>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="br2_cancel" class="btn light">Annulla</button>
      <button id="br2_send"   class="btn dark">Invia brindisi</button>
    </div>
    <div id="br2_msg" style="color:var(--err);margin-top:6px"></div>
  </div>
</div>

<!-- OVERLAY: Brindisi ricevuto -->
<div id="ovlBrRecv" class="overlay">
  <div class="sheet">
    <h3 id="brRecvTitle">üçæ Proposta di brindisi</h3>
    <div id="brRecvText" style="margin:8px 0 12px"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="brRecvDecline" class="btn light">Rifiuta</button>
      <button id="brRecvAccept" class="btn dark">Accetta & Brinda</button>
    </div>
  </div>
</div>

<!-- OVERLAY: Foto in chat tavolo ‚Üí link album -->
<div id="ovlAlbumHint" class="overlay">
  <div class="sheet" style="max-width:520px">
    <h3>Condividi meglio questa foto üì∏</h3>
    <p style="margin:8px 0 10px">
      Se la mandi qui la vedranno solo le persone del tuo tavolo.<br>
      Meglio caricarla nell‚Äôalbum ufficiale: cos√¨ la vedono tutti gli ospiti.
    </p>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <a id="albumLink" class="btn dark" target="_blank" rel="noopener">Vai all‚Äôalbum ufficiale</a>
      <button id="albumDismiss" class="btn light">Invia comunque al tavolo</button>
    </div>
  </div>
</div>

<!-- LIGHTBOX FOTO -->
<div id="ovlPhoto" class="overlay">
  <div class="sheet" style="padding:0;max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:flex-end">
    <button id="photoClose" class="btn light" style="margin:8px">Chiudi ‚úï</button>
    <img id="photoBig" src="" alt="Foto" style="max-width:100%;max-height:80vh;object-fit:contain;margin:auto">
  </div>
</div>

<!-- OVERLAY: Annuncio staff (invio) -->
<div id="ovlAnnuncioSend" class="overlay">
  <div class="sheet">
    <h3>Annuncio a tutti üì¢</h3>
    <input id="annText" class="fld" placeholder="Es. Torta tra 5 minuti!">
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="annCancel" class="btn light">Annulla</button>
      <button id="annSend" class="btn dark">Invia</button>
    </div>
    <div id="annMsg" style="margin-top:6px"></div>
  </div>
</div>

<!-- OVERLAY: Annuncio ricevuto -->
<div id="ovlAnnuncioShow" class="overlay">
  <div class="sheet" style="text-align:center">
    <div id="annBody" style="font-size:18px"></div>
    <div style="margin-top:12px">
      <button id="annOk" class="btn dark">Ok</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- HEIC converter -->
<script src="https://cdn.jsdelivr.net/npm/browser-heic-converter@1.0.2/dist/index.umd.min.js"></script>

<!-- FIREBASE + LOGICA -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, child, get, set, update, push, onChildAdded, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

  // ==== CONFIG FIREBASE ====
  const firebaseConfig = {
    apiKey: "AIzaSyAGGNyJE0Nj_KMb-jHjxWXTULa-gT3W9XQ",
    authDomain: "chat-matrimonio.firebaseapp.com",
    databaseURL: "https://chat-matrimonio-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chat-matrimonio",
    storageBucket: "chat-matrimonio.appspot.com",
    messagingSenderId: "533930991153",
    appId: "1:533930991153:web:d4c47af448e6ebfce73f10"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // ==== UTIL ====
  const $ = (id)=>document.getElementById(id);
  const norm  = (s)=> (s||'').trim().replace(/\s+/g,' ').replace(/[^\p{L}\p{N}\s.'-]/gu,'');
  const keyify= (s)=> norm(s).toLowerCase();
  const userPath = (t, n)=> `utenti/${t}/${keyify(n)}`;
  const toast = (t)=>{ const el=$('toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none', 2000); };
  const niceErr = (e)=> e?.message || (typeof e==='string'?e:String(e||'Errore'));

  // HEIC helpers
  function isHeic(file){ const n=(file?.name||'').toLowerCase(), t=(file?.type||'').toLowerCase(); return n.endsWith('.heic')||n.endsWith('.heif')||t.includes('heic')||t.includes('heif'); }
  function blobToDataURL(blob){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(new Error('Impossibile leggere il file.')); r.readAsDataURL(blob); }); }
  async function resizeToJpeg(dataURL, maxSide=900, quality=0.82){
    const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=()=>rej(new Error('Formato immagine non supportato.')); i.src=dataURL; });
    const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
    const w=Math.round(img.width*scale), h=Math.round(img.height*scale);
    const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
    const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
    const blob=await new Promise((res,rej)=>canvas.toBlob(b=>b?res(b):rej(new Error('Impossibile comprimere l‚Äôimmagine.')),'image/jpeg',quality));
    return blob;
  }
  async function toCompressedJpeg(file, maxSide=900, quality=0.82){
    let startBlob=file;
    if (isHeic(file)) {
      if (!(window.HEIC && window.HEIC.convert)) throw new Error("Il tuo browser non supporta ancora HEIC. Scegli JPG/PNG.");
      startBlob = await window.HEIC.convert(file, { toType:"image/jpeg", quality });
    }
    const dataURL = await blobToDataURL(startBlob);
    return await resizeToJpeg(dataURL, maxSide, quality);
  }

  // ==== STATO ====
  let currentUser = null; // {nome,tavolo,pin,emoji,fotoUrl,staff,canReset,optOutBrindisi}
  let chatUnsub = null;
  let dmUnsub = null;
  let dmIndexUnsub = null;
  let ALL_USERS = [];
  const AVATAR_CACHE = {}; // `${table}::${nameKey}` -> url | null

  // ==== NAV ====
  const screens = {
    home: $('screen-home'), create: $('screen-create'), login: $('screen-login'),
    chat: $('screen-chat'), profile: $('screen-profile'),
    dmChat: $('screen-dm-chat'),
  };
  function show(which){
    Object.values(screens).forEach(s=> s.style.display='none');
    screens[which].style.display='block';
  }

  // ==== HOME BTN ====
  $('btnCreate').onclick = ()=> show('create');
  $('btnLogin').onclick  = ()=> show('login');

  // ==== EMOJI (create) ====
  const emojiListEl = $('emojiList');
  let selectedEmoji = "";
  function bindEmojiList(initial=""){
    selectedEmoji = initial || "";
    [...emojiListEl.querySelectorAll('.emojiRow')].forEach(btn=>{
      btn.classList.toggle('is-selected', btn.dataset.emoji===(selectedEmoji||""));
      btn.onclick = ()=>{
        selectedEmoji = btn.dataset.emoji || "";
        [...emojiListEl.querySelectorAll('.emojiRow')].forEach(b=>b.classList.remove('is-selected'));
        btn.classList.add('is-selected');
      };
    });
  }
  bindEmojiList();

  // mostra emoji solo quando nome+tavolo+pin sono validi
  const cName = $('cName'), cTable=$('cTable'), cPin=$('cPin'), emojiBlock=$('emojiBlock');
  function createValid(){ return norm(cName.value) && cTable.value && /^\d{4}$/.test((cPin.value||'').trim()); }
  function updateEmojiVisibility(){ emojiBlock.style.display = createValid()? 'block':'none'; if (emojiBlock.style.display==='block') bindEmojiList(selectedEmoji||""); }
  ['input','change','keyup'].forEach(ev=>{ cName.addEventListener(ev,updateEmojiVisibility); cTable.addEventListener(ev,updateEmojiVisibility); cPin.addEventListener(ev,updateEmojiVisibility); });
  updateEmojiVisibility();

  // ==== CREA PROFILO ====
  $('cSave').onclick = async ()=>{
    const nome  = norm($('cName').value);
    const tavolo= $('cTable').value;
    const pin   = ($('cPin').value||'').trim();
    const fotoFile = $('cFoto').files?.[0] || null;
    const msg = $('cMsg'); msg.textContent=''; msg.style.color= 'inherit';
    if (!nome || !tavolo || !/^\d{4}$/.test(pin)) { msg.style.color='var(--err)'; msg.textContent='Compila nome, tavolo e PIN di 4 cifre.'; return; }

    const path = userPath(tavolo, nome);
    try {
      const snap = await get(child(ref(db), path));
      if (snap.exists()){ msg.style.color='var(--err)'; msg.textContent=`Nome gi√† usato al ${tavolo}. Aggiungi l‚Äôiniziale del cognome.`; return; }

      const user = { nome, nomeKey:keyify(nome), tavolo, pin, emoji:selectedEmoji||null, fotoUrl:null, staff:false, canReset:false, optOutBrindisi:false, createdAt:Date.now() };

      if (fotoFile){
        const jpeg = await toCompressedJpeg(fotoFile, 900, 0.85);
        const p = `pfp/${tavolo}/${keyify(nome)}.jpg`;
        const r = sRef(storage, p);
        await uploadBytes(r, jpeg, { contentType:'image/jpeg' });
        user.fotoUrl = await getDownloadURL(r);
      }

      await set(ref(db, path), user);
      currentUser = user;
      enterChatRoom();
    } catch(e){ msg.style.color='var(--err)'; msg.textContent='Errore: '+niceErr(e); }
  };

  // ==== LOGIN (con tavolo) ====
  $('lGo').onclick = async ()=>{
    const nome  = norm($('lName').value);
    const pin   = ($('lPin').value||'').trim();
    const tavolo= $('lTable').value;
    if (!nome || !/^\d{4}$/.test(pin) || !tavolo){ $('lMsg').textContent='Inserisci nome, PIN (4 cifre) e tavolo.'; return; }
    try{
      const snap = await get(child(ref(db), userPath(tavolo, nome)));
      if (snap.exists() && snap.val().pin===pin){
        currentUser = snap.val();
        enterChatRoom(); $('lMsg').textContent=''; return;
      }
      $('lMsg').textContent='Nome/PIN/Tavolo non validi.';
    }catch(e){ $('lMsg').textContent='Errore: '+niceErr(e); }
  };

  // ==== AVATAR Utils ====
  function getAvatarKey(table, name){ return `${table}::${keyify(name)}`; }
  function makeAvatarImg(name, table){
    const img = document.createElement('img');
    img.className = 'avatar28';
    img.alt = name;
    const k = getAvatarKey(table, name);
    const cached = AVATAR_CACHE[k];
    if (cached !== undefined) {
      if (cached) { img.src = cached; img.style.cursor='zoom-in'; img.onclick = ()=> showBigPhoto(cached); }
      return img;
    }
    get(child(ref(db), userPath(table, name))).then(snap=>{
      const url = snap.exists() ? (snap.val().fotoUrl || '') : '';
      AVATAR_CACHE[k] = url || null;
      if (url) { img.src = url; img.style.cursor='zoom-in'; img.onclick=()=>showBigPhoto(url); }
    }).catch(()=>{ AVATAR_CACHE[k]=null; });
    return img;
  }

  // ==== CHAT TAVOLO ====
  const chatRefFor = ()=> ref(db, `chats/${currentUser.tavolo}`);

  function renderTableMsg(container, m){
    const row = document.createElement('div');
    row.className = 'msgRow';
    const av = makeAvatarImg(m.user, currentUser.tavolo);
    row.appendChild(av);

    const bubble = document.createElement('div');
    bubble.className = 'msgBubble';

    const who = m.emoji ? `${m.user} ${m.emoji}` : m.user;
    const head = document.createElement('div'); head.className='msgHeader'; head.textContent = who;
    bubble.appendChild(head);

    if (m.type === 'img' && m.url){
      if (m.text) { const t=document.createElement('div'); t.textContent=m.text; t.style.marginBottom='6px'; bubble.appendChild(t); }
      const img = document.createElement('img'); img.className='imgMsg'; img.src=m.url; img.alt='Foto'; img.style.cursor='zoom-in'; img.onclick=()=>showBigPhoto(m.url);
      bubble.appendChild(img);
    } else {
      const txt = document.createElement('div'); txt.textContent = m.text || ''; bubble.appendChild(txt);
    }
    row.appendChild(bubble);
    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
  }

  function enterChatRoom(){
    $('chatTitle').textContent = currentUser.tavolo;
    $('meBadge').style.display = currentUser.staff ? 'inline-block' : 'none';
    $('btnAnnuncio').style.display = currentUser.staff ? 'inline-block' : 'none';
    if (currentUser.fotoUrl) { $('meAvatarBtn').src = currentUser.fotoUrl; $('meAvatarBtn').title='Profilo'; }
    else { $('meAvatarBtn').removeAttribute('src'); $('meAvatarBtn').title='Profilo'; }
    $('chatWindow').innerHTML = '';
    show('chat');

    // listener chat tavolo
    if (chatUnsub) chatUnsub();
    chatUnsub = onChildAdded(chatRefFor(), (snap)=> renderTableMsg($('chatWindow'), snap.val()));

    // Precarica avatar del mio tavolo
    get(child(ref(db), `utenti/${currentUser.tavolo}`)).then(s=>{
      if (s.exists()){
        const users = Object.values(s.val());
        users.forEach(u=>{ const k=getAvatarKey(currentUser.tavolo, u.nome); AVATAR_CACHE[k]=u.fotoUrl || null; });
      }
    });

    listenAnnouncements();
    // Tabs
    setTab('table');
    listenDMIndex();
    // Brindisi incoming
    setupBrindisiInbox();
  }

  $('chatSend').onclick = async ()=>{
    const t = ($('chatInput').value||'').trim();
    if (!t) return;
    const msgRef = push(chatRefFor());
    await set(msgRef, { type:'text', user: currentUser.nome, emoji: currentUser.emoji||null, text: t, time: Date.now() });
    $('chatInput').value='';
  };

  // Foto in chat tavolo ‚Üí suggerimento album
  const ALBUM_URL = "https://album.example.com"; // placeholder
  $('albumLink').href = ALBUM_URL;
  $('chatPhoto').onclick = ()=> $('chatPhotoFile').click();
  let pendingTablePhoto = null;
  $('chatPhotoFile').onchange = async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    pendingTablePhoto = f;
    $('ovlAlbumHint').style.display='flex';
  };
  $('albumDismiss').onclick = async ()=>{
    $('ovlAlbumHint').style.display='none';
    if (!pendingTablePhoto) return;
    try{
      const jpeg = await toCompressedJpeg(pendingTablePhoto, 1200, 0.85);
      const p = `chatImgs/${currentUser.tavolo}/${Date.now()}_${keyify(currentUser.nome)}.jpg`;
      const r = sRef(storage, p);
      await uploadBytes(r, jpeg, { contentType:'image/jpeg' });
      const url = await getDownloadURL(r);
      const msgRef = push(chatRefFor());
      await set(msgRef, { type:'img', user: currentUser.nome, emoji: currentUser.emoji||null, url, text:'', time: Date.now() });
      toast('Foto inviata al tavolo');
    }catch(e){ toast('Errore foto: '+niceErr(e)); }
    pendingTablePhoto = null;
    $('chatPhotoFile').value='';
  };

  // profilo/logout
  $('meAvatarBtn').onclick = ()=>{
    $('pName').textContent = currentUser.nome + (currentUser.emoji? ' '+currentUser.emoji : '');
    $('pTable').textContent = currentUser.tavolo;
    $('pFlags').innerHTML = '';
    if (currentUser.staff) $('pFlags').appendChild(Object.assign(document.createElement('span'),{className:'badge',textContent:'STAFF'}));
    if (currentUser.canReset) $('pFlags').appendChild(Object.assign(document.createElement('span'),{className:'badge',textContent:'Pu√≤ resettare'}));
    $('pFoto').src = currentUser.fotoUrl||'';
    setupProfileEmoji(currentUser.emoji||"");
    $('pOptOut').checked = !!currentUser.optOutBrindisi;
    show('profile');
  };
  $('btnLogout').onclick = ()=>{ currentUser=null; if (chatUnsub) chatUnsub(); chatUnsub=null; show('home'); };

  // ==== PROFILO ====
  $('pChangeFoto').onclick = ()=> $('pFotoInput').click();
  $('pFotoInput').onchange = async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    try{
      const jpeg = await toCompressedJpeg(f, 900, 0.85);
      const p = `pfp/${currentUser.tavolo}/${keyify(currentUser.nome)}.jpg`;
      const r = sRef(storage, p);
      await uploadBytes(r, jpeg, { contentType:'image/jpeg' });
      const url = await getDownloadURL(r);
      currentUser.fotoUrl = url;
      await update(ref(db, userPath(currentUser.tavolo, currentUser.nome)), { fotoUrl:url });
      $('pFoto').src = url; $('meAvatarBtn').src = url;
      toast('Foto aggiornata');
    }catch(e){ toast('Errore foto: '+niceErr(e)); }
  };
  function setupProfileEmoji(initial){
    const list = $('pEmojiList');
    [...list.querySelectorAll('.emojiRow')].forEach(btn=>{
      btn.classList.toggle('is-selected', btn.dataset.emoji===(initial||""));
      btn.onclick = ()=>{
        [...list.querySelectorAll('.emojiRow')].forEach(b=>b.classList.remove('is-selected'));
        btn.classList.add('is-selected');
        currentUser.emoji = btn.dataset.emoji || null;
      };
    });
  }
  $('pBack').onclick = ()=> show('chat');
  $('pSave').onclick = async ()=>{
    try{
      const updates = { emoji: currentUser.emoji || null, optOutBrindisi: !!$('pOptOut').checked };
      await update(ref(db, userPath(currentUser.tavolo, currentUser.nome)), updates);
      toast('Profilo salvato');
      show('chat');
    }catch(e){ $('pMsg').style.color='var(--err)'; $('pMsg').textContent='Errore: '+niceErr(e); }
  };

  // ==== LIGHTBOX FOTO ====
  const ovlPhoto = $('ovlPhoto'), photoBig=$('photoBig'); $('photoClose').onclick=()=> ovlPhoto.style.display='none';
  function showBigPhoto(url){ photoBig.src = url; ovlPhoto.style.display='flex'; }

  // ==== RICERCA (DM / Brindisi step1) ====
  const ovlSearch = $('ovlSearch'), sQuery=$('sQuery'), sResults=$('sResults'); $('sClose').onclick=()=> ovlSearch.style.display='none';
  async function fetchAllUsers(){
    const snap = await get(child(ref(db), 'utenti'));
    ALL_USERS = [];
    if (snap.exists()){
      const all = snap.val();
      Object.keys(all).forEach(t=> { Object.values(all[t]).forEach(u=> ALL_USERS.push(u)); });
    }
  }
  function personRow(u, onPick){
    const foto = u.fotoUrl || '';
    const emoji = u.emoji || '';
    const b = document.createElement('button');
    b.className='btn light'; b.style.textAlign='left'; b.style.display='flex'; b.style.alignItems='center'; b.style.gap='10px';
    const avHTML = foto ? `<img class="avatar24" src="${foto}">` : `<div class="avatar24" style="display:flex;align-items:center;justify-content:center;font:600 12px/24px system-ui">${u.nome.charAt(0).toUpperCase()}</div>`;
    b.innerHTML = `${avHTML}<div style="flex:1 1 auto">${u.nome} ${emoji} <span style="color:#666">‚Äî ${u.tavolo}</span></div>`;
    b.onclick = ()=> onPick(u);
    return b;
  }
  function tableRow(tavolo, onPick){
    const b=document.createElement('button'); b.className='btn light'; b.style.width='100%'; b.style.textAlign='left';
    b.textContent = `üçΩÔ∏è ${tavolo}`; b.onclick = ()=> onPick(tavolo); return b;
  }
  function openSearchOverlay(mode){ // 'dm' | 'brindisi'
    ovlSearch.style.display='flex';
    sQuery.value=''; sResults.innerHTML='<div style="color:#666;padding:8px">Scrivi un nome (Es. Edoardo) o un tavolo (Es. Tavolo 3)‚Ä¶</div>';
    sQuery.oninput = ()=>{
      const q = sQuery.value.trim().toLowerCase(); sResults.innerHTML = '';
      const tavoli = ["Tavolo 1","Tavolo 2","Tavolo 3","Tavolo 4"];
      const tavMatch = tavoli.filter(t=> q && (t.toLowerCase().includes(q) || t.replace(/\D/g,'')===q));
      const pplMatch = ALL_USERS.filter(u=> q && keyify(u.nome).includes(q));

      if (tavMatch.length){
        const h=document.createElement('div'); h.style.margin='8px 0 4px'; h.style.fontWeight='600'; h.textContent='Tavoli trovati';
        sResults.appendChild(h);
        tavMatch.forEach(t=> sResults.appendChild(tableRow(t, picked=>{
          if (mode==='dm') { ovlSearch.style.display='none'; openPickPersonForTable(picked); }
          else { openBrindisiPickForTable(picked); }
        })));
      }
      if (pplMatch.length){
        const h2=document.createElement('div'); h2.style.margin='8px 0 4px'; h2.style.fontWeight='600'; h2.textContent='Persone trovate';
        sResults.appendChild(h2);
        pplMatch.forEach(u=> sResults.appendChild(personRow(u, picked=>{
          ovlSearch.style.display='none';
          if (mode==='dm') openDMChatFromSearch(picked);
          else openBrindisiStep2({type:'user', user:picked});
        })));
      }
      if (!tavMatch.length && !pplMatch.length && q){ sResults.innerHTML='<div style="color:#666;padding:8px">Nessun risultato.</div>'; }
    };
  }

  // ==== DM (chat private) ====
  const dmWindow=$('dmWindow'), dmInput=$('dmInput');
  $('btnNewDM').onclick = async ()=>{ await fetchAllUsers(); openSearchOverlay('dm'); };

  function dmIdFor(a,b){ const A=keyify(a), B=keyify(b); return (A<B)? `${A}__${B}` : `${B}__${A}`; }
  async function openPickPersonForTable(tavolo){
    await fetchAllUsers();
    ovlSearch.style.display='flex';
    sQuery.value = '';
    sResults.innerHTML = `<div style="font-weight:600;margin:8px 6px">üçΩÔ∏è ${tavolo}</div>`;
    ALL_USERS.filter(u=> u.tavolo===tavolo && keyify(u.nome)!==keyify(currentUser.nome))
      .forEach(u=> sResults.appendChild(personRow(u, picked=>{ ovlSearch.style.display='none'; openDMChatFromSearch(picked); })));
  }
  async function openDMChatFromSearch(u){
    const id = dmIdFor(currentUser.nome, u.nome);
    await set(ref(db, `dmIndex/${keyify(currentUser.nome)}/${id}`), { otherName:u.nome, otherTable:u.tavolo, lastTime:Date.now() });
    await set(ref(db, `dmIndex/${keyify(u.nome)}/${id}`),               { otherName:currentUser.nome, otherTable:currentUser.tavolo, lastTime:Date.now() });
    openDMChat({ id, otherName:u.nome, otherTable:u.tavolo });
  }

  function setTab(active){ // 'table' | 'dms'
    const onTable = active==='table';
    $('tabTable').classList.toggle('active', onTable);
    $('tabDMs').classList.toggle('active', !onTable);
    $('chatWindow').style.display = onTable ? 'block' : 'none';
    $('chatInput').closest('.row').style.display = onTable ? 'flex' : 'none';
    $('dmList').style.display = onTable ? 'none' : 'flex';
    $('btnNewDM').style.display = onTable ? 'none' : 'inline-block';
  }
  $('tabTable').onclick = ()=> setTab('table');
  $('tabDMs').onclick   = ()=> { setTab('dms'); refreshDMList(); };

  async function ensureAllUsers(){ if (!ALL_USERS.length) await fetchAllUsers(); }
  function dmRow(meta){
    const b = document.createElement('button');
    b.className = 'btn light';
    b.style.textAlign = 'left';
    b.style.width = '100%';
    b.style.display = 'flex';
    b.style.alignItems = 'center';
    b.style.gap = '10px';

    const hit = ALL_USERS.find(u => keyify(u.nome)===keyify(meta.otherName));
    const emoji = hit?.emoji || '';
    const foto  = hit?.fotoUrl || '';
    const avHTML = foto ? `<img class="avatar24" src="${foto}" alt="">` :
      `<div class="avatar24" style="display:flex;align-items:center;justify-content:center;font:600 12px/24px system-ui">${(meta.otherName||'?').trim().charAt(0).toUpperCase()}</div>`;
    const when = meta.lastTime ? new Date(meta.lastTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

    b.innerHTML = `
      ${avHTML}
      <div style="flex:1 1 auto; min-width:0">
        <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${meta.otherName} ${emoji}
          <span style="color:#666; font-weight:400">‚Äî ${meta.otherTable||''}</span>
        </div>
      </div>
      <div style="color:#999; margin-left:8px">${when}</div>
    `;
    b.onclick = ()=> openDMChat(meta);
    return b;
  }
  function refreshDMListUI(indexObj){
    const box = $('dmList');
    box.innerHTML = '';
    const entries = Object.entries(indexObj||{}).map(([id,m])=> ({ id, ...m }));
    entries.sort((a,b)=> (b.lastTime||0)-(a.lastTime||0));
    if (!entries.length){
      box.innerHTML = `<div class="msg">Nessuna chat privata. Premi <strong>‚ûïüí¨</strong> per iniziarne una.</div>`;
      return;
    }
    entries.forEach(m => box.appendChild(dmRow(m)));
  }
  function listenDMIndex(){
    if (dmIndexUnsub) dmIndexUnsub();
    const myKey = keyify(currentUser.nome);
    dmIndexUnsub = onValue(ref(db, `dmIndex/${myKey}`), async (snap)=>{
      await ensureAllUsers();
      refreshDMListUI(snap.val()||{});
    });
  }
  function refreshDMList(){
    const myKey = keyify(currentUser.nome);
    get(ref(db, `dmIndex/${myKey}`)).then(async (snap)=>{
      await ensureAllUsers();
      refreshDMListUI(snap.val()||{});
    });
  }

  function openDMChat(meta){
    if (dmUnsub) { dmUnsub(); dmUnsub=null; }
    $('dmTitle').textContent = meta.otherName;
    dmWindow.innerHTML='';
    show('dmChat');
    const roomRef = ref(db, `privateChats/${meta.id}`);

    dmUnsub = onChildAdded(roomRef, async (snap)=>{
      const m = snap.val();
      // riuso il renderer "table" (va benissimo anche nei DM)
      renderTableMsg(dmWindow, m);
      const now = m.time || Date.now();
      await update(ref(db, `dmIndex/${keyify(currentUser.nome)}/${meta.id}`), { lastTime: now });
      await update(ref(db, `dmIndex/${keyify(meta.otherName)}/${meta.id}`),      { lastTime: now });
    });

    $('dmSend').onclick = async ()=>{
      const text = (dmInput.value||'').trim(); if (!text) return;
      const r = push(roomRef);
      const now = Date.now();
      await set(r, { type:'text', user: currentUser.nome, emoji: currentUser.emoji||null, text, time: now });
      await update(ref(db, `dmIndex/${keyify(currentUser.nome)}/${meta.id}`), { lastTime: now });
      dmInput.value='';
    };
    $('dmPhoto').onclick = ()=> $('dmPhotoFile').click();
    $('dmPhotoFile').onchange = async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      try{
        const jpeg = await toCompressedJpeg(f, 1200, 0.85);
        const p = `dmImgs/${meta.id}/${Date.now()}_${keyify(currentUser.nome)}.jpg`;
        const r = sRef(storage, p);
        await uploadBytes(r, jpeg, { contentType:'image/jpeg' });
        const url = await getDownloadURL(r);
        const mref = push(roomRef);
        const now = Date.now();
        await set(mref, { type:'img', user: currentUser.nome, emoji: currentUser.emoji||null, url, text:'', time: now });
        await update(ref(db, `dmIndex/${keyify(currentUser.nome)}/${meta.id}`), { lastTime: now });
        toast('Foto inviata');
      }catch(e){ toast('Errore foto: '+niceErr(e)); }
      e.target.value='';
    };

    $('dmc_back').onclick = ()=>{ if (dmUnsub) dmUnsub(); dmUnsub=null; show('chat'); setTab('dms'); refreshDMList(); };
  }

  // ==== BRINDISI ====
  const BR_PERSONA = [
    "Brinda in rima agli sposi","Brinda cantando un ritornello d‚Äôamore",
    "Brinda come un telecronista","Brinda in dialetto (o inventane uno!)",
    "Brinda come un sommelier","Brinda ringraziando i genitori",
    "Brinda a tema viaggio","Brinda come un pirata dei Caraibi"
  ];
  const BR_TAVOLO = [
    "Tutto il tavolo in piedi: fazzoletti al vento",
    "Brindisi a staffetta: una parola a testa (min 3)","Brindisi cantato tutti insieme",
    "Brindisi con rima finale urlata da tutti","Brindisi a ritmo di battiti di mani"
  ];
  function canSendBrindisi(){
    const last = +localStorage.getItem('cm_lastSend')||0;
    const left = 60000 - (Date.now()-last);
    return { ok: left<=0, left };
  }
  function markSendBrindisi(){ localStorage.setItem('cm_lastSend', String(Date.now())); }

  $('btnBrindisi').onclick = async ()=>{
    const cd = canSendBrindisi();
    if (!cd.ok){ toast(`Aspetta ${Math.ceil(cd.left/1000)}s per un altro brindisi`); return; }
    await fetchAllUsers();
    openSearchOverlay('brindisi'); // Step 1: target
  };

  const ovlBrStep2 = $('ovlBrStep2'), br2Title=$('br2_title'), br2Sub=$('br2_sub'), br2Label=$('br2_label'),
        br2List=$('br2_list'), br2More=$('br2_more'), br2Free=$('br2_free'), br2Msg=$('br2_msg');
  $('br2_cancel').onclick = ()=> ovlBrStep2.style.display='none';
  let br2Target=null;

  function renderBr2Suggestions(kind){
    const pool = kind==='user' ? BR_PERSONA : BR_TAVOLO;
    const pick = pool.slice().sort(()=>Math.random()-0.5).slice(0,4);
    br2List.innerHTML = '';
    pick.forEach(txt=>{
      const b=document.createElement('button'); b.className='br-sugg'; b.textContent=txt; b.onclick=()=> br2Free.value=txt;
      br2List.appendChild(b);
    });
  }
  function openBrindisiStep2(target){
    br2Target = target; br2Free.value=''; br2Msg.textContent='';
    if (target.type==='user'){
      const u=target.user; br2Title.textContent = `üçæ Brindisi per ${u.nome} ${u.emoji||''} ‚Äî ${u.tavolo}`;
      br2Sub.textContent='Scegli una sfida oppure scrivi la tua.'; br2Label.textContent='Proposte per te';
      renderBr2Suggestions('user');
    } else {
      br2Title.textContent = `üçæ Brindisi per ${target.tavolo}`;
      br2Sub.textContent='Scegli una sfida di gruppo oppure scrivi la tua.'; br2Label.textContent='Proposte per il tavolo';
      renderBr2Suggestions('table');
    }
    ovlBrStep2.style.display='flex';
  }
  $('br2_more').onclick = ()=> renderBr2Suggestions(br2Target?.type==='user'?'user':'table');
  $('br2_send').onclick = async ()=>{
    const cd = canSendBrindisi(); if (!cd.ok){ br2Msg.textContent=`Aspetta ${Math.ceil(cd.left/1000)}s`; return; }
    const testo = (br2Free.value||'').trim(); if (!testo){ br2Msg.textContent='Scegli una sfida o scrivi la tua.'; return; }
    if (br2Target?.type==='user'){
      const u = br2Target.user;
      if (u.optOutBrindisi){ br2Msg.textContent='Questo ospite non riceve sfide private.'; return; }
      await startBrindisiToUser(u, testo);
    } else if (br2Target?.type==='table'){
      await startBrindisiToTable(br2Target.tavolo, testo);
    }
    ovlBrStep2.style.display='none'; toast('Brindisi inviato! üçæ');
  };
  async function startBrindisiToUser(u, testo){
    const idRef = push(ref(db, 'brindisi/all'));
    const payload = { id:idRef.key, from:{nome:currentUser.nome,tavolo:currentUser.tavolo,emoji:currentUser.emoji||null},
      to:{type:'user', tavolo:u.tavolo, nome:u.nome}, text:testo, status:'pending', createdAt:Date.now() };
    await set(idRef, payload);
    await set(ref(db, `brindisi/inboxUser/${u.tavolo}/${keyify(u.nome)}/${payload.id}`), payload);
    markSendBrindisi();
  }
  async function startBrindisiToTable(tavolo, testo){
    const idRef = push(ref(db, 'brindisi/all'));
    const payload = { id:idRef.key, from:{nome:currentUser.nome,tavolo:currentUser.tavolo,emoji:currentUser.emoji||null},
      to:{type:'table', tavolo, nome:null}, text:testo, status:'pending', createdAt:Date.now() };
    await set(idRef, payload);
    await set(ref(db, `brindisi/inboxTable/${tavolo}/${payload.id}`), payload);
    markSendBrindisi();
  }

  // Brindisi ricevuti
  let brUserUnsub = null, brTableUnsub = null;
  const ovlBrRecv = $('ovlBrRecv'), brRecvTitle=$('brRecvTitle'), brRecvText=$('brRecvText');
  let currentBrInbox = null;

  function setupBrindisiInbox(){
    if (brUserUnsub) brUserUnsub();
    if (brTableUnsub) brTableUnsub();
    brUserUnsub = onChildAdded(
      ref(db, `brindisi/inboxUser/${currentUser.tavolo}/${keyify(currentUser.nome)}`),
      snap => showBrindisiRecv(snap.key, snap.val())
    );
    brTableUnsub = onChildAdded(
      ref(db, `brindisi/inboxTable/${currentUser.tavolo}`),
      snap => showBrindisiRecv(snap.key, snap.val())
    );
  }
  function showBrindisiRecv(id, payload){
    const from = payload.from;
    const who  = `${from.nome} ${from.emoji||''} ‚Äî ${from.tavolo}`;
    brRecvTitle.textContent = "üçæ Proposta di brindisi";
    brRecvText.textContent  = `${who} ti propone: ‚Äú${payload.text}‚Äù`;
    currentBrInbox = { id, payload };
    ovlBrRecv.style.display = 'flex';
  }
  async function clearInboxEntry(box){
    const p = (box.payload.to.type === 'user')
      ? `brindisi/inboxUser/${currentUser.tavolo}/${keyify(currentUser.nome)}/${box.id}`
      : `brindisi/inboxTable/${currentUser.tavolo}/${box.id}`;
    await set(ref(db, p), null);
  }
  $('brRecvAccept').onclick = async ()=>{
    if (!currentBrInbox) return;
    await update(ref(db, `brindisi/all/${currentBrInbox.id}`), { status:'accepted', acceptedAt:Date.now() });
    await clearInboxEntry(currentBrInbox);
    currentBrInbox = null;
    ovlBrRecv.style.display='none';
    toast('Cin cin! üçæ');
  };
  $('brRecvDecline').onclick = async ()=>{
    if (!currentBrInbox) return;
    await update(ref(db, `brindisi/all/${currentBrInbox.id}`), { status:'declined', declinedAt:Date.now() });
    await clearInboxEntry(currentBrInbox);
    currentBrInbox = null;
    ovlBrRecv.style.display='none';
  };

  // ==== ANNUNCI STAFF ====
  const ovlAnnuncioSend = $('ovlAnnuncioSend'), annText=$('annText'), annMsg=$('annMsg');
  $('btnAnnuncio').onclick = ()=>{
    if (!currentUser?.staff){ toast('Solo lo staff pu√≤ inviare annunci'); return; }
    annText.value=''; annMsg.textContent=''; ovlAnnuncioSend.style.display='flex';
  };
  $('annCancel').onclick = ()=> ovlAnnuncioSend.style.display='none';
  $('annSend').onclick = async ()=>{
    const t=(annText.value||'').trim(); if (!t){ annMsg.style.color='var(--err)'; annMsg.textContent='Scrivi un annuncio.'; return; }
    const r=push(ref(db,'annunci/all'));
    await set(r, { text:t, by:currentUser.nome, time:Date.now() });
    ovlAnnuncioSend.style.display='none';
    toast('Annuncio inviato');
  };
  // ricezione annunci
  const ovlAnnuncioShow = $('ovlAnnuncioShow'), annBody=$('annBody'); $('annOk').onclick=()=> ovlAnnuncioShow.style.display='none';
  let annOnce = false;
  function listenAnnouncements(){
    if (annOnce) return; annOnce=true;
    onChildAdded(ref(db,'annunci/all'), (snap)=>{
      const a=snap.val();
      annBody.textContent = a.text;
      ovlAnnuncioShow.style.display='flex';
      setTimeout(()=> (ovlAnnuncioShow.style.display='none'), 60000);
    });
  }

  // ==== DM TABS / LISTENER avvio ====
  function setTab(active){ /* definita sopra */ }
  function listenDMIndex(){ /* definita sopra */ }
  function refreshDMList(){ /* definita sopra */ }
</script>
</body>
</html>