<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Matrimonio</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --text:#111; --muted:#666;
      --pri:#111; --priText:#fff; --soft:#ededf0; --accent:#111;
      --chip:#eee; --ok:#0a7b34; --err:#b00020;
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --radius:18px; --radiusSm:10px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:680px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
    h1{font-size:32px;margin:8px 0 14px}
    h2{font-size:20px;margin:8px 0 10px}
    p{margin:0 0 10px}
    .center{text-align:center}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;border-radius:12px;padding:14px 16px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--pri);color:var(--priText)}
    .btn.soft{background:var(--soft);color:var(--text)}
    .btn.full{width:100%}
    .btn.small{padding:8px 10px;border-radius:10px}
    .stack-12>*{margin-top:12px}
    .row{display:flex;align-items:center;gap:10px}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:var(--chip);border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
    .chip.active{outline:2px solid #111}
    /* Tabs header */
    .topbar{display:flex;align-items:center;gap:8px;justify-content:flex-start;margin-bottom:12px}
    .tab{padding:10px 16px;border-radius:999px;background:var(--soft);cursor:pointer;font-weight:700}
    .tab.active{background:#111;color:#fff}
    .spacer{flex:1}
    .iconBtn{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;background:var(--soft);font-size:22px;cursor:pointer}
    /* Chat layout */
    .panel{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .msgList{height:52vh;overflow:auto;border-radius:12px;background:#fff;border:1px solid #eee;padding:10px}
    .msg{display:flex;align-items:flex-start;gap:8px;margin:8px 0;max-width:96%}
    .msg.me .bubble{background:#111;color:#fff}
    .avatar{width:34px;min-width:34px;height:34px;border-radius:999px;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700;color:#444;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .bubble{background:#f1f1f4;border-radius:14px;padding:8px 10px}
    .small{font-size:12px}
    .inputRow{display:flex;gap:8px}
    .inputRow input{flex:1;padding:14px;border-radius:12px;border:1px solid #ddd;background:#fff}
    /* Drawer elenco DM */
    .dmList{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px}
    .dmItem{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;cursor:pointer}
    .dmItem:hover{background:#f5f5f7}
    .hint{background:#fff8e1;border:1px solid #ffe2a3;border-radius:12px;padding:10px}
    /* Overlay generico */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .sheet{width:min(680px,100%);max-height:86vh;overflow:auto;background:#fff;border-radius:20px;padding:16px;box-shadow:var(--shadow)}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .footRight{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
    /* Form */
    .field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .field input,.field select{padding:14px;border-radius:12px;border:1px solid #ddd;background:#fff}
    .statusRow{display:grid;grid-template-columns:auto 1fr;gap:12px;margin:8px 0;align-items:center;cursor:pointer;border-radius:12px;padding:6px}
    .statusRow.active{outline:2px solid #111;background:#f6f6f8}
    /* FAB profilo */
    .fab{position:fixed;right:18px;bottom:18px;background:#fff;border:1px solid #eee;box-shadow:var(--shadow);border-radius:999px;padding:8px 12px;display:flex;align-items:center;gap:8px;cursor:pointer;z-index:20}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;border-radius:999px;padding:10px 14px;display:none;z-index:50}
    /* Full photo */
    .photoView{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:60}
    .photoView img{max-width:94vw;max-height:90vh;border-radius:12px}
    /* Messaggi immagine */
    .msgPhoto{max-width:62vw;height:auto;border-radius:14px;display:block;border:1px solid #eee;background:#fff}
    /* Helpers */
    .hidden{display:none !important}
    
    /* ————— Wedding Theme (verde salvia / panna) ————— */
.theme-wedding{
  --bg:#eef3ef;            /* sfondo generale */
  --card:#fffdf9;          /* card chiara “panna” */
  --text:#203127;          /* testo scuro ma morbido */
  --muted:#6e7b72;
  --pri:#6f8f7a;           /* bottone principale verde salvia */
  --priText:#fff;
  --soft:#e8efe9;          /* chip/tab soft */
  --chip:#ecf2ee;
  --accent:#6f8f7a;
  --shadow:0 10px 28px rgba(49,77,63,.10);
  --radius:24px;           /* angoli più rotondi */
  --radiusSm:14px;
}

/* leggero pattern foliage sullo sfondo */
.theme-wedding body{
  background:
    radial-gradient(1200px 600px at 80% -200px, rgba(111,143,122,.12), transparent 60%),
    radial-gradient(900px 500px at -200px 80%, rgba(111,143,122,.10), transparent 60%),
    var(--bg);
}

/* card e pannelli “soft” */
.theme-wedding .card,
.theme-wedding .panel,
.theme-wedding .dmList{
  border-radius:var(--radius);
  border:1px solid rgba(111,143,122,.12);
  box-shadow:var(--shadow);
  background:var(--card);
}

/* tab stile pill */
.theme-wedding .tab{ background:var(--soft); color:#2a3a31 }
.theme-wedding .tab.active{ background:var(--pri); color:var(--priText) }

/* bottoni */
.theme-wedding .btn.primary{ background:var(--pri); color:var(--priText) }
.theme-wedding .btn.soft{ background:var(--soft) }
.theme-wedding .iconBtn{ background:var(--soft) }

/* avatar: cerchio con sottile bordo caldo */
.theme-wedding .avatar{
  border:1px solid rgba(111,143,122,.18);
  background:#f5f7f5;
}

/* bubble più “cartolina” */
.theme-wedding .bubble{
  background:#f5f8f6;
  border:1px solid rgba(111,143,122,.14);
  border-radius:18px;
}

/* immagine nei messaggi: cornice */
.theme-wedding .msgPhoto{
  border-radius:18px;
  border:1px solid rgba(111,143,122,.18);
  box-shadow:0 8px 20px rgba(49,77,63,.10);
}

/* input arrotondati */
.theme-wedding .inputRow input{
  border:1px solid rgba(111,143,122,.22);
  background:#fff;
}

/* status rows (profilo) evidenziate */
.theme-wedding .statusRow.active{
  outline:2px solid rgba(111,143,122,.6);
  background:#f1f6f3;
}

/* piccoli badge “single/engaged” (se li userai) */
.theme-wedding .chip, .theme-wedding .small-badge{
  background:#ecf2ee; color:#2a3a31; border:1px solid rgba(111,143,122,.18);
}

/* decoro floreale negli angoli dei pannelli principali */
.theme-wedding #tableView > .row:first-child,
.theme-wedding #dmChatView > .row:first-child,
.theme-wedding #dmListView h3{
  position:relative;
}
.theme-wedding #tableView > .row:first-child::after,
.theme-wedding #dmChatView > .row:first-child::after{
  content:"";
  position:absolute; right:8px; top:-8px; width:70px; height:70px; opacity:.75;
  background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'>\
<g fill='none' stroke='rgba(111,143,122,.45)' stroke-width='2'>\
<path d='M60 20c-8 12-14 14-24 22M90 36c-10 5-16 15-26 18'/>\
</g>\
<g fill='#f6e9e4' stroke='rgba(172,120,112,.35)' stroke-width='1.5'>\
<circle cx='94' cy='26' r='10'/>\
<circle cx='28' cy='28' r='9'/>\
</g>\
</svg>");
  background-size:contain; background-repeat:no-repeat;
  pointer-events:none;
}
    
  </style>
  
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="theme-wedding.css">
  
</head>
<body>
<div class="wrap" id="app">

  <!-- HOME -->
  <section id="home" class="card center">
    <div class="avatar" style="margin:0 auto 8px;width:54px;height:54px;">EF</div>
    <h1>Benvenuto 🎉</h1>
    <p>Qui puoi <b>conoscere e chattare con gli altri invitati</b> del matrimonio.</p>
    <p>Puoi lanciare un brindisi speciale 🍾 per rompere il ghiaccio,</p>
    <p>oppure aprire una <b>chat privata</b> 💬 per parlare direttamente con chi vuoi.</p>
    <p class="muted" style="margin-top:10px"><b>Nota:</b> tutto quello che succede qui si cancella dopo <b>72 ore</b>… quindi divertiti e lasciati andare 😉</p>
    <div class="stack-12" style="margin-top:14px">
      <button id="btnNew" class="btn primary full">Crea nuovo profilo</button>
      <button id="btnLogin" class="btn soft full">Rientra nel tuo profilo</button>
    </div>
  </section>

  <!-- MAIN -->
  <section id="main" class="hidden">
    <div class="topbar">
      <div id="tabDMs" class="tab active">Private</div>
      <div id="tabTable" class="tab">Tavolo</div>
      <div class="spacer"></div>
      <div id="btnBrindisi" class="iconBtn" title="Proponi brindisi">🍾</div>
      <div id="btnNewChat" class="iconBtn" title="Nuova chat">💬</div>
      <div id="btnAnnuncio" class="iconBtn hidden" title="Annuncio staff">📢</div>
    </div>

    <!-- PRIVATE: LIST VIEW -->
    <div id="dmListView" class="dmList">
      <h3 style="margin:6px 8px">Le tue chat</h3>
      <div id="dmEmpty" class="muted" style="padding:8px 10px">Nessuna chat privata. Premi “💬” in alto a destra.</div>
      <div id="dmList"></div>
    </div>

    <!-- PRIVATE: CHAT VIEW -->
    <div id="dmChatView" class="panel hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:8px">
          <button id="dmBack" class="btn soft small">←</button>
          <div id="dmHead" class="row" style="gap:8px">
            <div id="dmAva" class="avatar" style="width:34px;height:34px">P</div>
            <h2 id="dmTitle" style="margin:0">Chat privata</h2>
          </div>
        </div>
      </div>
      <div id="dmWindow" class="msgList"></div>
      <div class="inputRow">
        <input id="dmInput" placeholder="Scrivi un messaggio…" />
        <button id="dmPicBtn" class="btn soft" title="Invia foto">📷</button>
        <button id="dmSend" class="btn primary">Invia</button>
        <input id="dmPicFile" type="file" accept="image/*" class="hidden">
      </div>
    </div>

    <!-- TABLE VIEW -->
    <div id="tableView" class="panel hidden">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:8px">
          <div id="tableBadge" class="avatar" style="width:34px;height:34px">T</div>
          <h2 id="tableTitle" style="margin:0">Tavolo</h2>
        </div>
      </div>
      <div id="tableMessages" class="msgList"></div>
      <div class="inputRow">
        <input id="tableInput" placeholder="Scrivi un messaggio…" />
        <button id="tablePicBtn" class="btn soft" title="Invia foto al tavolo">📷</button>
        <button id="tableSend" class="btn primary">Invia</button>
        <input id="tablePicFile" type="file" accept="image/*" class="hidden">
      </div>
    </div>
  </section>

  <!-- FAB profilo -->
  <div id="fabProfile" class="fab hidden">
    <div id="fabAva" class="avatar" style="width:28px;height:28px">L</div>
    <span>Profilo</span>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">Ok</div>

  <!-- VIEW PHOTO -->
  <div id="photoFull" class="photoView"><img alt="foto profilo" /></div>

  <!-- OVERLAYS -->

  <!-- login / new -->
  <div id="ovAuth" class="overlay">
    <div class="sheet" style="max-width:560px">
      <h2 id="authTitle">Crea nuovo profilo</h2>

      <!-- STEP 1 -->
      <div id="authStep1">
        <div class="field"><label>Nome</label><input id="aName" placeholder="es. Giulia R." /></div>
        <div class="twoCols">
          <div class="field"><label>PIN (4 cifre)</label><input id="aPin" inputmode="numeric" maxlength="4" placeholder="PIN" /></div>
          <div class="field">
            <label>Tavolo</label>
            <select id="aTable">
              <option value="" selected>Seleziona tavolo</option>
              <option>Tavolo 1</option><option>Tavolo 2</option><option>Tavolo 3</option>
              <option>Tavolo 4</option><option>Tavolo 5</option><option>Tavolo 6</option>
              <option>Tavolo 7</option><option>Tavolo 8</option><option>Tavolo 9</option><option>Tavolo 10</option>
            </select>
          </div>
        </div>
      </div>

      <!-- STEP 2 -->
      <div id="authStep2" class="hidden">
        <h3 style="margin:6px 0 6px">Personalizza (opzionale)</h3>

        <div class="field">
          <label>Selfie</label>
          <input id="aPhoto" type="file" accept="image/*">
          <div class="muted small">Consiglio: scatta un selfie adesso, è più divertente!</div>
        </div>

        <!-- righe status/emoji: CLICCABILI -->
        <div class="statusRow" data-emo="💍"><div class="avatar" style="width:30px;height:30px">💍</div><div><b>Impegnato/a</b></div></div>
        <div class="statusRow" data-emo="💬"><div class="avatar" style="width:30px;height:30px">💬</div><div><b>Disponibile a chiacchierare</b></div></div>
        <div class="statusRow" data-emo="🎉"><div class="avatar" style="width:30px;height:30px">🎉</div><div><b>Voglia di far festa</b></div></div>
        <div class="statusRow" data-emo="✨"><div class="avatar" style="width:30px;height:30px">✨</div><div><b>Sorprendimi</b></div></div>
        <div class="statusRow" data-emo=""><div class="avatar" style="width:30px;height:30px">—</div><div><b>Nessuna</b></div></div>

        <!-- scimmietta su una sola riga -->
        <label id="optRow" style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <input id="aOptOut" type="checkbox" />
          <span>🙈 Non ricevere sfide private (brindisi)</span>
        </label>

        <!-- toggle suoni -->
        <label id="soundRow" style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <input id="aSounds" type="checkbox" checked />
          <span>🔔 Suoni attivi</span>
        </label>

        <!-- tasto ESci (solo quando profilo aperto) -->
        <div id="logoutRow" class="footRight hidden">
          <button id="btnLogout" class="btn soft">Esci</button>
        </div>
      </div>

      <div class="footRight">
        <button id="aCancel" class="btn soft">Chiudi</button>
        <button id="aNext" class="btn primary">Continua</button>
      </div>
      <div id="authErr" class="muted" style="color:var(--err);margin-top:6px"></div>
    </div>
  </div>

  <!-- ricerca persone/tavoli -->
  <div id="ovSearch" class="overlay">
    <div class="sheet">
      <h2 id="searchTitle">Cerca ospite o tavolo</h2>
      <div class="field"><input id="sQuery" placeholder="Scrivi nome o tavolo…" /></div>
      <div id="sResults"></div>
      <div class="footRight"><button id="sClose" class="btn soft">Chiudi</button></div>
    </div>
  </div>

  <!-- picker Brindisi -->
  <div id="ovBrindisi" class="overlay">
    <div class="sheet">
      <h2 id="brindisiTitle">Proponi brindisi</h2>
      <div id="bGrid" class="twoCols" style="margin-top:8px"></div>
      <div class="field" style="margin-top:10px"><input id="bCustom" placeholder="Oppure scrivi la tua sfida…" /></div>
      <div class="footRight">
        <button id="bShuffle" class="btn soft">Altri suggerimenti</button>
        <button id="bCancel" class="btn soft">Annulla</button>
        <button id="bSend" class="btn primary">Invia</button>
      </div>
      <div id="bErr" class="muted" style="color:var(--err);margin-top:6px"></div>
    </div>
  </div>

  <!-- brindisi in arrivo: popup -->
  <div id="ovBrIn" class="overlay">
    <div class="sheet">
      <h2>Brindisi per te 🍾</h2>
      <div id="brInText" style="margin:8px 0 12px;font-size:18px"></div>
      <div class="footRight">
        <button id="brInNo" class="btn soft">Rifiuta</button>
        <button id="brInYes" class="btn primary">Accetta e brinda</button>
      </div>
    </div>
  </div>

  <!-- avviso foto tavolo -->
  <div id="ovPhotoWarn" class="overlay">
    <div class="sheet">
      <h2>Condividi la foto 📸</h2>
      <p style="margin:6px 0 10px">Se vuoi farla vedere a <b>tutti gli ospiti</b>, caricala nell’album del matrimonio.</p>
      <div class="footRight">
        <a id="albumLink" class="btn soft" href="#" target="_blank" rel="noopener">Apri album</a>
        <button id="warnCancel" class="btn soft">Annulla</button>
        <button id="warnSend" class="btn primary">Invia solo al tavolo</button>
      </div>
    </div>
  </div>

  <!-- annuncio staff -->
  <div id="ovAnnuncio" class="overlay">
    <div class="sheet">
      <h2>Invia annuncio a tutti</h2>
      <div class="field"><input id="annText" placeholder="Testo dell’annuncio…" /></div>
      <div class="footRight">
        <button id="annCancel" class="btn soft">Annulla</button>
        <button id="annSend" class="btn primary">Invia</button>
      </div>
    </div>
  </div>

</div>

<!-- Firebase (compat per semplicità) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

<script>
/* ========= UTIL ========= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const keyify = s => (s||'').trim().toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]/g,'').slice(0,40);
const now = () => Date.now();
const toast = (t)=>{ const el=$('#toast'); el.textContent=t; el.style.display='block'; setTimeout(()=>el.style.display='none',2200); };
const show = id => $$('#home,#main').forEach(x=>x.id===id?x.classList.remove('hidden'):x.classList.add('hidden'));
const openOverlay = el => { if(el.style.display==='flex')return; document.body.style.overflow='hidden'; el.style.display='flex'; }
const closeOverlay = el => { if(el.style.display!=='flex')return; el.style.display='none'; document.body.style.overflow=''; }
const randPick = (arr, n) => arr.slice().sort(()=>Math.random()-0.5).slice(0,n);
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
document.addEventListener('click',(e)=>{const sh=e.target.closest('.sheet'); if(!sh && e.target.classList.contains('overlay')) closeOverlay(e.target);},true);

function avatarEl(u){
  const a = document.createElement('div');
  a.className='avatar'; a.textContent=(u.nome||'?').substring(0,1).toUpperCase();
  if (u.photoURL){ const i=document.createElement('img'); i.src=u.photoURL; a.innerHTML=''; a.appendChild(i); a.dataset.full=u.photoURL; }
  a.setAttribute('data-full', u.photoURL||'');
  return a;
}

/* ========= SUONI (WebAudio) ========= */
const SND = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let unlocked=false;
  ['touchstart','mousedown','keydown'].forEach(ev=>document.addEventListener(ev,()=>{if(!unlocked){ctx.resume();unlocked=true;}},{once:true,passive:true}));
  const getPref = ()=> localStorage.getItem('sound_on')!=='0';
  function beep(freq=880, dur=0.08, gain=0.06, type='sine', when=0){
    if(!getPref()) return;
    const t = ctx.currentTime + when;
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+dur);
  }
  const pop=()=>{beep(200,.03,.09,'square',0);beep(120,.08,.05,'sine',.03);}
  const clink=()=>{beep(1400,.04,.06,'triangle',0);beep(1800,.06,.05,'triangle',.03);}
  const ping=()=>{beep(900,.06,.05,'sine',0);}
  const notify=()=>{beep(600,.06,.05,'sine',0);beep(800,.06,.04,'sine',.07);}
  return {pop,clink,ping,notify,getPref};
})();

/* ========= FIREBASE ========= */
const firebaseConfig = {
  apiKey: "AIzaSyAGGNyJE0Nj_KMb-jHjxWXTULa-gT3W9XQ",
  authDomain: "chat-matrimonio.firebaseapp.com",
  projectId: "chat-matrimonio",
  storageBucket: "chat-matrimonio.firebasestorage.app",
  messagingSenderId: "533930991153",
  appId: "1:533930991153:web:d4c47af448e6ebfce73f10",
  databaseURL: "https://chat-matrimonio-default-rtdb.europe-west1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ========= STATO ========= */
let currentUser = null;     // {id, nome, tavolo, tavKey, emoji, photoURL, isStaff, optOut}
let dmPeer = null;          // utente aperto nei DM
let dmIdOpen = null;        // id chat aperta
let unsubDM = null, unsubTable = null;

/* ========= HOME BTN ========= */
$('#btnNew').onclick = ()=> openAuth(true);
$('#btnLogin').onclick = ()=> openAuth(false);

/* ========= AUTH ========= */
let selectedEmoji = ''; // per righe verticali

function bindStatusRows(){
  $$('#authStep2 .statusRow').forEach(r=>{
    r.onclick = ()=>{
      $$('#authStep2 .statusRow').forEach(x=>x.classList.remove('active'));
      r.classList.add('active');
      selectedEmoji = r.dataset.emo || '';
    };
  });
}

function openAuth(isNew){
  $('#authTitle').textContent = isNew ? 'Crea nuovo profilo' : 'Rientra nel tuo profilo';
  $('#aNext').textContent = 'Continua';
  $('#authErr').textContent = '';
  $('#authStep1').classList.remove('hidden');
  $('#authStep2').classList.add('hidden');
  $('#logoutRow').classList.add('hidden');
  $('#aName').value = ''; $('#aPin').value = ''; $('#aTable').value = '';
  $('#aPhoto').value = ''; $('#aOptOut').checked = false;
  $('#aSounds').checked = (localStorage.getItem('sound_on')!=='0');
  selectedEmoji = ''; $$('#authStep2 .statusRow').forEach(x=>x.classList.remove('active'));
  $('#aNext').dataset.mode = isNew ? 'new1' : 'login';
  openOverlay($('#ovAuth'));
  bindStatusRows();
}
$('#aCancel').onclick = ()=> closeOverlay($('#ovAuth'));

$('#aNext').onclick = async ()=>{
  const mode = $('#aNext').dataset.mode;

  if (mode==='login'){
    const nome = $('#aName').value.trim();
    const pin  = $('#aPin').value.trim();
    const tav  = $('#aTable').value.trim();
    if (!nome || !pin || !/^\d{4}$/.test(pin) || !tav){ $('#authErr').textContent='Compila nome, PIN (4 cifre) e tavolo.'; return; }
    const id = keyify(nome);
    const snap = await db.ref('users/'+id).get();
    if (!snap.exists()){ $('#authErr').textContent='Utente non trovato. Crea un profilo.'; return; }
    const u = snap.val();
    if (String(u.pin)!==pin || u.tavolo!==tav){ $('#authErr').textContent='Nome/PIN/Tavolo non corrispondono.'; return; }
    currentUser = {...u, id};
    localStorage.setItem('remember_user', JSON.stringify({id, nome, pin, tav}));
    localStorage.setItem('sound_on', $('#aSounds').checked ? '1' : '0');
    afterLogin();
    closeOverlay($('#ovAuth'));
    return;
  }

  if (mode==='new1'){
    const nome = $('#aName').value.trim();
    const pin  = $('#aPin').value.trim();
    const tav  = $('#aTable').value.trim();
    if (!nome || !pin || !/^\d{4}$/.test(pin) || !tav){ $('#authErr').textContent='Compila nome, PIN (4 cifre) e tavolo.'; return; }
    // vai a STEP 2
    $('#authStep1').classList.add('hidden');
    $('#authStep2').classList.remove('hidden');
    $('#aNext').textContent = 'Salva e entra';
    $('#aNext').dataset.mode = 'new2';
    return;
  }

  if (mode==='new2'){
    const nome = $('#aName').value.trim();
    const pin  = $('#aPin').value.trim();
    const tav  = $('#aTable').value.trim();
    const id = keyify(nome);
    const tavKey = keyify(tav);
    const emoji = selectedEmoji;
    const optOut = $('#aOptOut').checked;

    // upload selfie (opzionale)
    let photoURL = '';
    const f = $('#aPhoto').files[0];
    if (f){
      if (!/^image\//.test(f.type)){ $('#authErr').textContent='Carica un\'immagine.'; return; }
      const path = `pfp/${tavKey}/${id}.jpg`;
      const snap = await storage.ref(path).put(f);
      photoURL = await snap.ref.getDownloadURL();
    }

    const userData = { nome, pin, tavolo:tav, tavKey, emoji, photoURL, optOut, isStaff:false, ts:now() };
    await db.ref('users/'+id).set(userData);
    currentUser = {...userData, id};
    localStorage.setItem('remember_user', JSON.stringify({id, nome, pin, tav}));
    localStorage.setItem('sound_on', $('#aSounds').checked ? '1' : '0');
    afterLogin();
    closeOverlay($('#ovAuth'));
    return;
  }
};

/* ========= AUTOLOGIN ========= */
(async function autologin(){
  try{
    const r = JSON.parse(localStorage.getItem('remember_user')||'null');
    if (!r) return;
    const snap = await db.ref('users/'+r.id).get();
    if (!snap.exists()) return;
    const u = snap.val();
    if (u && String(u.pin)===String(r.pin) && u.tavolo===r.tav){
      currentUser = {...u, id:r.id};
      afterLogin();
    }
  }catch(e){}
})();

/* ========= LOGOUT ========= */
$('#btnLogout')?.addEventListener('click', ()=>{
  localStorage.removeItem('remember_user');
  dmPeer = null; dmIdOpen = null;
  try{
    if (unsubDM && currentUser && dmIdOpen) db.ref('chats/dm/'+dmIdOpen+'/messages').off('child_added', unsubDM);
    if (unsubTable && currentUser) db.ref('chats/table/'+currentUser.tavKey+'/messages').off('child_added', unsubTable);
  }catch(e){}
  currentUser = null;
  show('home');
  closeOverlay($('#ovAuth'));
  toast('Sei uscit*');
});

/* ========= DOPO LOGIN ========= */
let _activeTab = 'dms';
function afterLogin(){
  $('#fabProfile').classList.remove('hidden');
  $('#btnAnnuncio').classList.toggle('hidden', !currentUser.isStaff);
  $('#fabAva').textContent = (currentUser.nome||'?').substring(0,1).toUpperCase();
  if (currentUser.photoURL){ const i=document.createElement('img'); i.src=currentUser.photoURL; $('#fabAva').innerHTML=''; $('#fabAva').appendChild(i); }
  $('#tableBadge').textContent='T';
  $('#tableTitle').textContent = currentUser.tavolo;
  show('main');
  // apri per default PRIVATE (lista)
  setTab('dms'); showDmList();

  // attach listeners
  listenTable();
  refreshDMList();
  listenAnnouncements();
  listenBrindisi(); // popup brindisi
  toast('Benvenut* ' + currentUser.nome + '!');
}

/* ========= TABS ========= */
$('#tabDMs').onclick   = ()=> { setTab('dms'); showDmList(); };
$('#tabTable').onclick = ()=> setTab('table');

function setTab(which){
  if (which === _activeTab) return;
  _activeTab = which;
  const onDM = which==='dms';
  $('#tabDMs').classList.toggle('active', onDM);
  $('#tabTable').classList.toggle('active', !onDM);
  $('#dmListView').classList.toggle('hidden', !onDM);
  $('#dmChatView').classList.add('hidden');
  $('#tableView').classList.toggle('hidden', onDM);
}

/* ========= PROFILO ========= */
$('#fabProfile').onclick = openProfile;
function openProfile(){
  // editor veloce (riuso step2)
  $('#authTitle').textContent = 'Profilo';
  $('#authStep1').classList.add('hidden');
  $('#authStep2').classList.remove('hidden');
  $('#aNext').textContent = 'Salva';
  $('#aNext').dataset.mode = 'saveProfile';
  $('#logoutRow').classList.remove('hidden');
  $('#aName').value = currentUser.nome;
  $('#aPin').value = currentUser.pin;
  $('#aTable').value = currentUser.tavolo;
  $('#aOptOut').checked = !!currentUser.optOut;
  $('#aSounds').checked = (localStorage.getItem('sound_on')!=='0');
  selectedEmoji = currentUser.emoji || '';
  $$('#authStep2 .statusRow').forEach(r=>{
    r.classList.toggle('active', (r.dataset.emo||'') === selectedEmoji);
  });
  openOverlay($('#ovAuth'));
  bindStatusRows();
}
$('#aNext').addEventListener('click', async (e)=>{
  if ($('#aNext').dataset.mode!=='saveProfile') return;
  const emoji = selectedEmoji;
  const optOut = $('#aOptOut').checked;
  let photoURL = currentUser.photoURL || '';
  const f = $('#aPhoto').files[0];
  if (f){
    const path = `pfp/${currentUser.tavKey}/${currentUser.id}.jpg`;
    const snap = await storage.ref(path).put(f);
    photoURL = await snap.ref.getDownloadURL();
  }
  await db.ref('users/'+currentUser.id).update({ emoji, optOut, photoURL });
  currentUser = {...currentUser, emoji, optOut, photoURL};
  if (photoURL){ const i=document.createElement('img'); i.src=photoURL; $('#fabAva').innerHTML=''; $('#fabAva').appendChild(i); }
  localStorage.setItem('sound_on', $('#aSounds').checked ? '1' : '0');
  closeOverlay($('#ovAuth'));
  toast('Profilo aggiornato');
});

/* ========= AVATAR FULL ========= */
document.body.addEventListener('click', (e)=>{
  const av = e.target.closest('.avatar');
  if (!av) return;
  const url = av.dataset.full;
  if (!url) return;
  $('#photoFull img').src = url;
  $('#photoFull').style.display='flex';
});
$('#photoFull').onclick = ()=> $('#photoFull').style.display='none';

/* ========= CHAT TAVOLO ========= */
function renderMsg(m, me, inTable=false){
  const row = document.createElement('div');
  row.className = 'msg'+(me?' me':'');
  const av = avatarEl({nome:m.name||m.fromName||'?', photoURL:m.photoURL||m.fromPhoto});
  row.appendChild(av);

  const b = document.createElement('div');

  if (m.type === 'img' && m.url){
    const im = document.createElement('img');
    im.className = 'msgPhoto';
    im.src = m.url;
    im.alt = 'immagine';
    b.appendChild(im);
  } else {
    b.className='bubble';
    b.innerHTML = escapeHtml(m.text || '');
  }

  // “Rispondi in privato” per messaggi esterni nel tavolo
  if (inTable && m.fromId && !me){
    const br = document.createElement('div'); br.style.marginTop='6px';
    const btn = document.createElement('button'); btn.className='btn soft small'; btn.textContent='Rispondi in privato';
    btn.onclick = async ()=>{
      const us = await db.ref('users/'+m.fromId).get();
      if (!us.exists()) { toast('Utente non trovato'); return; }
      openDMChat({id:m.fromId, ...us.val()});
    };
    br.appendChild(btn); b.appendChild(br);
  }

  row.appendChild(b);
  return row;
}
function baseMessage(text){
  return {
    type:'text',
    text, ts:now(),
    uid: currentUser.id,
    name: currentUser.nome,
    photoURL: currentUser.photoURL||'',
    emoji: currentUser.emoji||'',
    table: currentUser.tavolo
  };
}
function listenTable(){
  if (unsubTable) db.ref('chats/table/'+currentUser.tavKey+'/messages').off('child_added', unsubTable);
  const path = 'chats/table/'+currentUser.tavKey+'/messages';
  const list = $('#tableMessages'); list.innerHTML='';
  unsubTable = db.ref(path).on('child_added', snap=>{
    const m = snap.val();
    list.appendChild(renderMsg(m, m.uid===currentUser.id, true));
    list.scrollTop = list.scrollHeight;
  });
}
$('#tableSend').onclick = async ()=>{
  const v = $('#tableInput').value.trim(); if(!v) return;
  const m = baseMessage(v);
  await db.ref('chats/table/'+currentUser.tavKey+'/messages').push(m);
  $('#tableInput').value='';
};

/* === Foto nel TAVOLO (con avviso album) === */
let pendingTableFile = null;
$('#tablePicBtn').onclick = ()=> $('#tablePicFile').click();
$('#tablePicFile').onchange = (e)=>{
  const f = e.target.files[0]; if(!f){ e.target.value=''; return; }
  pendingTableFile = f;
  // apri avviso
  openOverlay($('#ovPhotoWarn'));
};
$('#warnCancel').onclick = ()=>{
  pendingTableFile = null;
  $('#tablePicFile').value='';
  closeOverlay($('#ovPhotoWarn'));
};
$('#albumLink').onclick = ()=> {
  // TODO: sostituire link con quello reale dell’album
  $('#albumLink').setAttribute('href', '#'); // placeholder
  closeOverlay($('#ovPhotoWarn'));
};
$('#warnSend').onclick = async ()=>{
  try{
    if(!pendingTableFile) return;
    const msgRef = db.ref('chats/table/'+currentUser.tavKey+'/messages').push();
    const key = msgRef.key;
    const path = `chat/table/${currentUser.tavKey}/${key}.jpg`;
    const snap = await storage.ref(path).put(pendingTableFile);
    const url  = await snap.ref.getDownloadURL();
    await msgRef.set({
      type:'img', url, ts:now(),
      uid: currentUser.id, name: currentUser.nome,
      photoURL: currentUser.photoURL||'', emoji: currentUser.emoji||'', table: currentUser.tavolo
    });
    toast('Foto inviata al tavolo');
  }catch(e){ console.error(e); toast('Errore invio foto'); }
  finally{
    pendingTableFile = null;
    $('#tablePicFile').value='';
    closeOverlay($('#ovPhotoWarn'));
  }
};

/* ========= MESSAGGIO ESTERNO verso tavoli (dal search) ========= */
async function sendExternalToTable(tableName, tableKey, text){
  const m = {
    ...baseMessage(text),
    fromId: currentUser.id,
    fromName: currentUser.nome,
    fromTable: currentUser.tavolo,
    fromEmoji: currentUser.emoji||'',
    fromPhoto: currentUser.photoURL||'',
  };
  await db.ref('chats/table/'+tableKey+'/messages').push(m);
  toast('Messaggio inviato a ' + tableName);
}

/* ========= DM ========= */
function dmId(a,b){ return [a,b].sort().join('__'); }

// mostra solo elenco
function showDmList(){
  $('#dmListView').classList.remove('hidden');
  $('#dmChatView').classList.add('hidden');
  refreshDMList();
}
$('#dmBack').onclick = showDmList;

$('#btnNewChat').onclick = ()=> openSearch('dm');

async function openDMChat(user){
  dmPeer = user;
  const id = dmId(currentUser.id, user.id);
  dmIdOpen = id;
  // header
  $('#dmAva').innerHTML = ''; $('#dmAva').textContent=(user.nome||'?')[0]?.toUpperCase()||'?';
  if (user.photoURL){ const i=document.createElement('img'); i.src=user.photoURL; $('#dmAva').appendChild(i); }
  $('#dmTitle').textContent = user.nome + (user.emoji?(' '+user.emoji):'');
  // vista
  $('#dmListView').classList.add('hidden');
  $('#dmChatView').classList.remove('hidden');
  // attach
  $('#dmWindow').innerHTML='';
  if (unsubDM) db.ref('chats/dm/'+id+'/messages').off('child_added', unsubDM);
  unsubDM = db.ref('chats/dm/'+id+'/messages').on('child_added', snap=>{
    const m = snap.val();
    $('#dmWindow').appendChild(renderMsg(m, m.uid===currentUser.id, false));
    $('#dmWindow').scrollTop = $('#dmWindow').scrollHeight;
    if (m.uid !== currentUser.id) SND.notify();
  });
  // aggiorna meta per ordinamento
  await db.ref('chats/dm/'+id+'/meta').update({ a:currentUser.id, b:user.id, ts:now() });
}

$('#dmSend').onclick = async ()=>{
  if (!dmPeer) return;
  const v = $('#dmInput').value.trim(); if(!v) return;
  const id = dmIdOpen;
  await db.ref('chats/dm/'+id+'/messages').push(baseMessage(v));
  await db.ref('chats/dm/'+id+'/meta').update({ a:currentUser.id, b:dmPeer.id, ts:now(), last:v });
  $('#dmInput').value='';
};

/* === Foto nei DM === */
$('#dmPicBtn').onclick = ()=> $('#dmPicFile').click();
$('#dmPicFile').onchange = async (e)=>{
  const file = e.target.files[0];
  if (!file) return;
  if (!dmPeer){ toast('Apri una chat privata prima di inviare una foto'); e.target.value=''; return; }

  try{
    const id = dmIdOpen || dmId(currentUser.id, dmPeer.id);
    const msgRef = db.ref('chats/dm/'+id+'/messages').push();
    const key = msgRef.key;
    const path = `chat/dm/${id}/${key}.jpg`;

    const snap = await storage.ref(path).put(file);
    const url  = await snap.ref.getDownloadURL();

    await msgRef.set({
      type:'img', url, ts:now(),
      uid: currentUser.id, name: currentUser.nome,
      photoURL: currentUser.photoURL||'', emoji: currentUser.emoji||'', table: currentUser.tavolo
    });

    await db.ref('chats/dm/'+id+'/meta').update({ a:currentUser.id, b:dmPeer.id, ts:now(), last:'📷 foto' });

    e.target.value = '';
  }catch(err){
    console.error(err);
    toast('Errore invio foto');
  }
};

/* ========= BRINDISI ========= */
const B_USER = [
 'Brinda in rima per gli sposi','Brindisi dialettale!','Brinda con il vicino di sedia',
 'Brinda guardando negli occhi','Brindisi nominando i genitori degli sposi','Brinda come un telecronista',
 'Brinda come un poeta','Racconta un aneddoto buffo (30s) e brinda','Canta una parola del brindisi',
 'Brinda citando una canzone famosa'
];
const B_TABLE = [
 'Tutti in piedi e brindisi con fazzoletto!','Brindisi al tavolo accanto','Brindisi “call & response” (una parola a testa)',
 'Brindisi a staff cucina/sala','Brindisi per il tavolo degli sposi','Brindisi in rima per il tavolo'
];

let brindisiTarget = null; // {type:'user'|'table', id, name}
$('#btnBrindisi').onclick = ()=> openSearch('brindisi');

function openBrindisiPicker(){
  $('#bErr').textContent='';
  $('#brindisiTitle').textContent = 'Proponi brindisi a ' + brindisiTarget.name;
  fillBrindisiGrid();
  openOverlay($('#ovBrindisi'));
}
function fillBrindisiGrid(){
  const arr = brindisiTarget.type==='table' ? B_TABLE : B_USER;
  const g = $('#bGrid'); g.innerHTML='';
  randPick(arr, 4).forEach(t=>{
    const b = document.createElement('button'); b.className='btn soft'; b.textContent=t; b.onclick=()=>{$('#bCustom').value=t;};
    g.appendChild(b);
  });
}
$('#bShuffle').onclick = fillBrindisiGrid;
$('#bCancel').onclick = ()=> closeOverlay($('#ovBrindisi'));
$('#bSend').onclick = async ()=>{
  const text = $('#bCustom').value.trim();
  if(!text){ $('#bErr').textContent='Scegli un suggerimento o scrivi la tua sfida.'; return; }

  // cooldown mittente (60s) + cooldown ricezione target (180s)
  const cdSendKey = 'cd_send_'+currentUser.id;
  if (Number(localStorage.getItem(cdSendKey)) > now()){ $('#bErr').textContent='Calma! Puoi inviare un brindisi ogni 60s.'; return; }
  const cdRecvKey = brindisiTarget.type==='table' ? ('cd_table_'+brindisiTarget.id) : ('cd_user_'+brindisiTarget.id);
  if (Number(localStorage.getItem(cdRecvKey)) > now()){ $('#bErr').textContent='Quel destinatario ha già ricevuto una sfida di recente.'; return; }

  const payload = { text, from:currentUser.id, fromName:currentUser.nome, fromTable:currentUser.tavolo, ts:now() };
  if (brindisiTarget.type==='table'){
    await db.ref('brindisi/table/'+brindisiTarget.id).push(payload);
  }else{
    await db.ref('brindisi/user/'+brindisiTarget.id).push(payload);
  }

  localStorage.setItem(cdSendKey, String(now()+60000));
  localStorage.setItem(cdRecvKey, String(now()+180000));
  closeOverlay($('#ovBrindisi'));
  toast('Sfida brindisi inviata!');
};

/* ======= Brindisi in arrivo: POPUP ======= */
function showIncomingBrindisi(b){
  $('#brInText').innerHTML = `${escapeHtml(b.fromName||'Qualcuno')} — <span class="muted">${escapeHtml(b.fromTable||'')}</span><br>ti propone: “<b>${escapeHtml(b.text||'')}</b>”`;
  openOverlay($('#ovBrIn'));
  SND.pop();
  const close = ()=> closeOverlay($('#ovBrIn'));
  $('#brInNo').onclick = ()=>{ SND.ping(); toast('Brindisi rifiutato'); close(); };
  $('#brInYes').onclick = ()=>{ SND.clink(); toast('Cin cin! 🥂'); close(); };
}
function listenBrindisi(){
  // per me (utente)
  db.ref('brindisi/user/'+currentUser.id).on('child_added', (snap)=>{
    const b = snap.val(); showIncomingBrindisi(b);
  });
  // per il mio tavolo
  db.ref('brindisi/table/'+currentUser.tavKey).on('child_added', (snap)=>{
    const b = snap.val(); showIncomingBrindisi(b);
  });
}

/* ========= ANNUNCI STAFF ========= */
$('#btnAnnuncio').onclick = ()=> openOverlay($('#ovAnnuncio'));
$('#annCancel').onclick = ()=> closeOverlay($('#ovAnnuncio'));
$('#annSend').onclick = async ()=>{
  const t = $('#annText').value.trim(); if(!t) return;
  await db.ref('annunci/all').push({ text:t, ts:now(), by:currentUser.nome||'staff' });
  $('#annText').value=''; closeOverlay($('#ovAnnuncio')); toast('Annuncio inviato');
};
function listenAnnouncements(){
  db.ref('annunci/all').on('child_added', snap=>{
    const a = snap.val(); const id = snap.key;
    const seenKey = 'ann_seen_'+id;
    if (localStorage.getItem(seenKey)) return;
    toast('📢 ' + a.text);
    localStorage.setItem(seenKey, '1');
  });
}

/* ========= RICERCA ========= */
$('#btnNewChat').onclick   = ()=> openSearch('dm');
$('#sClose').onclick = ()=> closeOverlay($('#ovSearch'));

function openSearch(mode){ // 'dm' | 'brindisi'
  $('#searchTitle').textContent = mode==='brindisi' ? 'Cerca ospite o tavolo per Brindisi' : 'Cerca ospite o tavolo';
  $('#sQuery').value=''; $('#sResults').innerHTML='';
  $('#ovSearch').dataset.mode = mode;
  $('#sQuery').oninput = ()=> doSearch(mode);
  openOverlay($('#ovSearch'));
  $('#sQuery').focus();
}

async function doSearch(mode){
  const q = $('#sQuery').value.trim().toLowerCase();
  const box = $('#sResults'); box.innerHTML='';
  if (!q) return;

  // utenti
  const usSnap = await db.ref('users').get();
  const users = []; const tablesMap = new Map();
  usSnap.forEach(s=>{
    const u = s.val();
    users.push({id:s.key, ...u});
    tablesMap.set(u.tavolo, u.tavKey);
  });

  // match tavoli + persone
  const tableMatches = Array.from(tablesMap.keys()).filter(t => t.toLowerCase().includes(q));
  const byName  = users.filter(u => u.nome.toLowerCase().includes(q));

  // tavoli trovati: mostra tavolo + TUTTI gli ospiti di quel tavolo
  if (tableMatches.length){
    for (const tName of tableMatches){
      const tKey = tablesMap.get(tName);
      const row = document.createElement('div');
      row.className='dmItem'; row.innerHTML=`<div class="avatar">T</div><div><b>${tName}</b></div>`;
      row.onclick = ()=>{
        closeOverlay($('#ovSearch'));
        if (mode==='brindisi'){ brindisiTarget={type:'table', id:tKey, name:tName}; openBrindisiPicker(); }
        else {
          const txt = prompt('Messaggio al tavolo '+tName+':'); if (!txt) return;
          sendExternalToTable(tName, tKey, txt);
        }
      };
      box.appendChild(row);

      // ospiti del tavolo
      users.filter(u=>u.tavolo===tName).forEach(u=>{
        const r2 = document.createElement('div');
        r2.className='dmItem';
        r2.appendChild(avatarEl(u));
        const info = document.createElement('div');
        info.innerHTML = `<b>${u.nome}</b> ${u.emoji||''} — <span class="muted small">${u.tavolo}</span>`;
        r2.appendChild(info);
        r2.onclick = ()=>{
          closeOverlay($('#ovSearch'));
          if (mode==='brindisi'){ brindisiTarget={type:'user', id:u.id, name:u.nome}; openBrindisiPicker(); }
          else openDMChat(u);
        };
        box.appendChild(r2);
      });
    }
  }

  // match per nome (potrebbero esserci più Luca su tavoli diversi)
  byName.forEach(u=>{
    const r = document.createElement('div');
    r.className='dmItem'; r.appendChild(avatarEl(u));
    const info = document.createElement('div');
    info.innerHTML = `<b>${u.nome}</b> ${u.emoji||''} — <span class="muted small">${u.tavolo}</span>`;
    r.appendChild(info);
    r.onclick = ()=>{
      closeOverlay($('#ovSearch'));
      if (mode==='brindisi'){ brindisiTarget={type:'user', id:u.id, name:u.nome}; openBrindisiPicker(); }
      else openDMChat(u);
    };
    box.appendChild(r);
  });

  if (!box.children.length){
    box.innerHTML = `<div class="muted" style="padding:8px 10px">Nessun risultato</div>`;
  }
}

/* ========= START ========= */
show('home');
document.body.classList.add('theme-wedding');
</script>
</body>
</html>